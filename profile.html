<!DOCTYPE html>
<html lang="en">
<head>
<title>My Profile - Earth Property</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px;}
header{background:#2e7d32;color:white;padding:12px;text-align:center;position:fixed;top:0;left:0;right:0;z-index:100;}
header h1{margin:0;font-size:20px;}
.back-btn{position:absolute;left:15px;top:15px;background:rgba(255,255,255,0.2);border:none;color:white;padding:8px;border-radius:20px;font-size:16px;cursor:pointer;}

.cover{height:160px;background:linear-gradient(135deg,#2e7d32,#4caf50);position:relative;overflow:hidden;}
.cover img{width:100%;height:100%;object-fit:cover;}
.profile-pic{
 width:110px;height:110px;border-radius:50%;
 border:5px solid white;
 position:absolute;bottom:-55px;left:20px;
 background:#f0f0f0 url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjQwIiBmaWxsPSIjRTVFNUU1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUw0NSA0NUw2NSAyNUg1MEgyNVoiIGZpbGw9IiM4QTg5OEkiLz4KPC9zdmc+') center/contain no-repeat;
 box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
.profile-pic img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.edit-btn{
 position:absolute;bottom:8px;right:8px;
 background:#2e7d32;color:white;border:none;
 padding:6px 10px;border-radius:20px;font-size:12px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.edit-btn:active{background:#1b5e20;}

.box{background:white;margin:75px 15px 15px;padding:20px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.input-group{position:relative;margin:15px 0;}
input{width:100%;padding:14px;border:1px solid #ddd;border-radius:12px;font-size:16px;box-sizing:border-box;background:white;}
input:focus{outline:none;border-color:#2e7d32;box-shadow:0 0 0 2px rgba(46,125,50,0.1);}
input:disabled{background:#f5f5f5;color:#666;}
.save-btn{background:linear-gradient(135deg,#2e7d32,#4caf50);color:white;border:none;padding:14px;border-radius:12px;font-size:16px;font-weight:500;cursor:pointer;width:100%;box-shadow:0 4px 12px rgba(46,125,50,0.3);}
.save-btn:active{transform:translateY(1px);}
.save-btn:disabled{opacity:0.6;cursor:not-allowed;background:#ccc;}
.status{padding:10px;border-radius:8px;margin-top:10px;display:none;}
.status.success{background:#e8f5e9;color:#2e7d32;}
.status.error{background:#ffebee;color:#c62828;}
</style>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

</head>
<body>

<header>
 <h1>üë§ My Profile</h1>
 <button class="back-btn" onclick="goHome()">üè† Home</button>
</header>

<div class="cover">
 <img id="coverImg" src="https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&h=300&q=80">
 <input type="file" id="coverInput" accept="image/*" hidden>
</div>

<div class="profile-pic">
 <img id="profileImg" src="https://via.placeholder.com/110/2e7d32/ffffff?text=üë§">
 <button class="edit-btn" onclick="document.getElementById('profileInput').click()">‚úèÔ∏è Edit</button>
 <input type="file" id="profileInput" accept="image/*" hidden>
</div>

<div class="box">
 <div class="input-group">
  <input id="name" placeholder="Your Name" maxlength="50">
 </div>
 <div class="input-group">
  <input id="phone" placeholder="Phone Number" type="tel" maxlength="15">
 </div>
 <div class="input-group">
  <input id="email" placeholder="Email" disabled>
 </div>
 <button id="saveBtn" class="save-btn" onclick="saveProfile()">üíæ Save Profile</button>
 <div id="statusMsg" class="status"></div>
</div>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let uid=null;

// ‚úÖ Cloudinary FREE TIER config
const CLOUD_NAME = "dnkhurnbv";
const UPLOAD_PRESET = "earth-property";

// üî• Upload to Cloudinary + Progress
async function uploadToCloudinary(file, isCover=false){
 const previewImg = isCover ? document.getElementById('coverImg') : document.getElementById('profileImg');
 previewImg.src = "https://i.imgur.com/8Km9tLL.gif"; // Loading spinner
 
 const form = new FormData();
 form.append("file", file);
 form.append("upload_preset", UPLOAD_PRESET);
 
 try{
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
   method: "POST",
   body: form
  });
  
  if(!res.ok) throw new Error('Upload failed');
  
  const data = await res.json();
  return data.secure_url;
 }catch(e){
  previewImg.src = isCover ? "https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&h=300&q=80" : "https://via.placeholder.com/110/2e7d32/ffffff?text=üë§";
  throw e;
 }
}

// üîê Auth + Load Profile
auth.onAuthStateChanged(async user=>{
 if(!user){
  showStatus("Please login first", "error");
  setTimeout(()=>location.href="login.html", 1500);
  return;
 }
 uid=user.uid;
 document.getElementById('email').value=user.email;

 try{
  const doc = await db.collection("users").doc(uid).get();
  if(doc.exists){
   const d = doc.data();
   document.getElementById('name').value = d.name || "";
   document.getElementById('phone').value = d.phone || "";
   if(d.photoURL) document.getElementById('profileImg').src = d.photoURL;
   if(d.coverURL) document.getElementById('coverImg').src = d.coverURL;
  }
 }catch(e){
  console.error("Profile load error:", e);
 }
});

// üñºÔ∏è Profile Photo Upload
document.getElementById('profileInput').onchange = async (e)=>{
 const file = e.target.files[0];
 if(!file || !uid) return;
 
 try{
  const url = await uploadToCloudinary(file, false);
  document.getElementById('profileImg').src = url;
  await db.collection("users").doc(uid).set({photoURL:url},{merge:true});
  showStatus("Profile photo updated! ‚úÖ", "success");
 }catch(e){
  showStatus("Upload failed. Try again.", "error");
 }
};

// üñºÔ∏è Cover Photo Upload
document.getElementById('coverImg').onclick = ()=>document.getElementById('coverInput').click();
document.getElementById('coverInput').onchange = async (e)=>{
 const file = e.target.files[0];
 if(!file || !uid) return;
 
 try{
  const url = await uploadToCloudinary(file, true);
  document.getElementById('coverImg').src = url;
  await db.collection("users").doc(uid).set({coverURL:url},{merge:true});
  showStatus("Cover photo updated! ‚úÖ", "success");
 }catch(e){
  showStatus("Upload failed. Try again.", "error");
 }
};

// üíæ Save Profile Data
async function saveProfile(){
 const saveBtn = document.getElementById('saveBtn');
 const name = document.getElementById('name').value.trim();
 const phone = document.getElementById('phone').value.trim();
 
 if(!name && !phone){
  showStatus("Please fill at least one field", "error");
  return;
 }
 
 saveBtn.disabled = true;
 saveBtn.textContent = "Saving...";
 
 try{
  await db.collection("users").doc(uid).set({
   name: name || firebase.firestore.FieldValue.delete(),
   phone: phone || firebase.firestore.FieldValue.delete(),
   updated: Date.now()
  },{merge:true});
  
  showStatus("Profile saved successfully! ‚úÖ", "success");
  setTimeout(goHome, 1500);
 }catch(e){
  showStatus("Save failed. Try again.", "error");
  console.error("Save error:", e);
 }finally{
  saveBtn.disabled = false;
  saveBtn.textContent = "üíæ Save Profile";
 }
}

// üî• MISSING FUNCTIONS ADD KIYE (YEH PROBLEM THI!)
function showStatus(msg, type){
 const status = document.getElementById('statusMsg');
 status.textContent = msg;
 status.className = `status ${type}`;
 status.style.display = 'block';
 setTimeout(()=>status.style.display='none', 3000);
}

function goHome(){
 window.location.href='index.html';
}

// üì± PWA Ready
if("serviceWorker" in navigator){
 navigator.serviceWorker.register("/earth-property/sw.js").catch(console.log);
}
</script>

</body>
</html>
