<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Earth Property - Final Pro Plus</title>
<style>
    body { margin:0; font-family:system-ui, -apple-system, sans-serif; background:#f0f2f5; padding-bottom:75px; overflow-x:hidden; -webkit-tap-highlight-color:transparent; }
    header { background:#2e7d32; color:white; padding:15px; position:sticky; top:0; z-index:1000; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    /* Advanced Filter UI */
    .filter-section { background:white; padding:12px; position:sticky; top:62px; z-index:999; border-bottom:1px solid #eee; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .search-box { display:flex; gap:8px; margin-bottom:10px; }
    #searchInput { flex:1; padding:12px; border-radius:12px; border:1.5px solid #eee; background:#f9f9f9; outline:none; font-size:14px; transition: 0.3s; }
    #searchInput:focus { border-color: #2e7d32; background: #fff; }
    .chips-wrapper { display:flex; gap:8px; overflow-x:auto; padding-bottom:5px; scrollbar-width:none; }
    .chips-wrapper::-webkit-scrollbar { display:none; }
    .filter-select { padding:8px 12px; border-radius:10px; border:1px solid #eee; background:#f1f1f1; font-size:12px; font-weight:600; color:#444; outline:none; min-width:90px; }

    /* Property Cards */
    .section { display:none; animation: fadeIn 0.3s ease; }
    .section.active { display:block; }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

    .card { background:white; margin:15px 12px; padding:12px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,.06); position: relative; }
    .slider { display:flex; overflow-x:auto; scroll-snap-type:x mandatory; scrollbar-width:none; gap:10px; border-radius:15px; }
    .slider::-webkit-scrollbar { display:none; }
    .slider img { min-width:100%; height:260px; object-fit:cover; scroll-snap-align:center; background:#f0f0f0; cursor: zoom-in; }
    
    .price-tag { color:#2e7d32; font-size: 22px; font-weight:800; margin: 12px 0 2px; }
    .time-tag { font-size:10px; color:#999; float:right; margin-top:5px; }
    .bhk-badge { background:#e8f5e9; color:#2e7d32; padding:3px 8px; border-radius:6px; font-size:11px; font-weight:700; text-transform:uppercase; }
    .loc-tag { color:#666; font-size:13px; display:flex; align-items:center; gap:4px; margin-top: 6px; }

    /* Buttons */
    .manage-btns { display:flex; gap:10px; margin-top:15px; border-top: 1px solid #f0f0f0; padding-top: 12px; }
    .btn-edit { flex:1; padding:12px; border-radius:12px; border:1.5px solid #2e7d32; color:#2e7d32; background:none; font-weight:bold; cursor:pointer; }
    .btn-del { flex:1; padding:12px; border-radius:12px; border:none; background:#fff1f0; color:#d32f2f; font-weight:bold; cursor:pointer; }

    /* Fullscreen Gallery */
    #gallery { position:fixed; inset:0; background:black; display:none; z-index:99999; }
    #gallerySlider { display:flex; height:100vh; overflow-x:auto; scroll-snap-type:x mandatory; scrollbar-width:none; }
    .gallery-item { flex:0 0 100vw; display:flex; align-items:center; justify-content:center; }
    .gallery-item img { max-width:100%; max-height:100%; object-fit:contain; }
    #galClose { position:absolute; top:25px; right:25px; color:white; background:rgba(0,0,0,0.4); border:none; width:45px; height:45px; border-radius:50%; font-size:30px; z-index:100; cursor:pointer; }

    /* Bottom Nav */
    .nav-bar { position:fixed; bottom:0; width:100%; background:white; display:flex; height:65px; border-top:1px solid #eee; z-index:1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:11px; color:#777; cursor:pointer; }
    .nav-item.active { color:#2e7d32; font-weight:bold; }
    .nav-item i { font-size:24px; margin-bottom:2px; }
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

<header>
    <div>
        <h2 style="margin:0; font-size:18px; letter-spacing:-0.5px;">Earth Property</h2>
        <span id="uNameTop" style="font-size:11px; opacity:0.8;">Syncing...</span>
    </div>
    <img id="uPicTop" src="" style="width:38px;height:38px;border-radius:50%;border:2px solid #fff; object-fit:cover;">
</header>

<div class="filter-section" id="filterUI">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search City, Area or Society...">
        <select id="filterType" class="filter-select" style="background:#e8f5e9; color:#2e7d32; border:none;">
            <option value="All">Rent/Buy</option>
            <option value="Rent">Rent</option>
            <option value="Sell">Buy</option>
        </select>
    </div>
    <div class="chips-wrapper">
        <select id="filterBHK" class="filter-select">
            <option value="All">All BHK</option>
            <option value="1">1 BHK</option>
            <option value="2">2 BHK</option>
            <option value="3">3 BHK</option>
            <option value="4">4+ BHK</option>
        </select>
        <select id="filterPrice" class="filter-select">
            <option value="0-999999999">Any Budget</option>
            <option value="0-20000">Under 20k</option>
            <option value="20000-50000">20k - 50k</option>
            <option value="1000000-5000000">10L - 50L</option>
            <option value="5000000-999999999">50L+</option>
        </select>
    </div>
</div>

<div id="homeSec" class="section active">
    <div id="feedAll" style="min-height:80vh;"></div>
</div>

<div id="profileSec" class="section">
    <div style="padding:30px 20px; background:white; text-align:center; border-radius:0 0 25px 25px;">
        <img id="uPicBig" src="" style="width:85px;height:85px;border-radius:50%;border:4px solid #e8f5e9;">
        <h3 id="uNameBig" style="margin:12px 0 5px;">User Name</h3>
        <button onclick="logout()" style="color:#d32f2f; border:none; background:none; font-weight:600; cursor:pointer;">LOGOUT</button>
    </div>
    <h4 style="margin:20px 15px 10px; color:#333; display:flex; align-items:center; gap:8px;">
        <i class="material-icons" style="color:#2e7d32">inventory_2</i> My Properties
    </h4>
    <div id="feedMy"></div>
</div>

<div id="gallery">
    <button id="galClose" onclick="closeGal()">√ó</button>
    <div id="gallerySlider"></div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="tab('homeSec', this)">
        <i class="material-icons">explore</i><span>Explore</span>
    </div>
    <div class="nav-item" onclick="goPost()">
        <i class="material-icons" style="font-size:32px; color:#2e7d32;">add_circle</i><span>Post</span>
    </div>
    <div class="nav-item" onclick="tab('profileSec', this)">
        <i class="material-icons">account_circle</i><span>My Ads</span>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = { 
    apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain:"earth-properties-c3c56.firebaseapp.com", 
    projectId:"earth-properties-c3c56",
    storageBucket: "earth-properties-c3c56.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let allPostsCache = [];

// üõ†Ô∏è POLISH: Time Ago Logic
function timeAgo(date) {
    if(!date) return "";
    const seconds = Math.floor((new Date() - date.toDate()) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + "y ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + "mo ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + "d ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + "h ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + "m ago";
    return "Just now";
}

auth.onAuthStateChanged(user => {
    if(user) {
        const name = user.displayName || user.email.split('@')[0];
        const img = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=2e7d32&color=fff`;
        document.getElementById("uNameTop").innerText = "Hi, " + name;
        document.getElementById("uPicTop").src = img;
        document.getElementById("uNameBig").innerText = name;
        document.getElementById("uPicBig").src = img;
    }
    loadAll();
});

// --- DATA ENGINE ---
async function loadAll() {
    const box = document.getElementById("feedAll");
    box.innerHTML = "<center style='padding:50px; color:#999;'>Fetching properties...</center>";
    try {
        const snap = await db.collection("properties").orderBy("timestamp", "desc").limit(100).get();
        allPostsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderList(allPostsCache, box, false);
    } catch(e) {
        box.innerHTML = "<center style='padding:50px;'>Error. Check Firestore Indexes.</center>";
    }
}

async function loadMy() {
    const box = document.getElementById("feedMy");
    box.innerHTML = "<p style='text-align:center;'>Loading your ads...</p>";
    const snap = await db.collection("properties").where("ownerId", "==", auth.currentUser.uid).get();
    const myPosts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderList(myPosts, box, true);
}

function renderList(posts, container, isMine) {
    container.innerHTML = posts.length === 0 ? "<p style='text-align:center;padding:50px;color:#999;'>No matches found.</p>" : "";
    posts.forEach(p => {
        const card = document.createElement('div');
        card.className = "card";
        card.id = "c-" + p.id;
        
        const cleanPhone = (p.phone || "").toString().replace(/\D/g, "");
        const imgs = p.images || [];
        const timeLabel = timeAgo(p.timestamp);
        
        // üõ†Ô∏è POLISH: WhatsApp Integration
        const waMsg = encodeURIComponent(`Hi, I'm interested in your property: ${p.title} (‚Çπ${p.price})`);
        const waLink = `https://wa.me/91${cleanPhone}?text=${waMsg}`;

        card.innerHTML = `
            <div class="slider">
                ${imgs.map(i => `<img src="${i}" onclick="openGal('${encodeURIComponent(JSON.stringify(imgs))}')" loading="lazy">`).join("")}
            </div>
            <div style="padding:5px">
                <span class="time-tag">${timeLabel}</span>
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-top:12px;">
                    <div>
                        <span class="bhk-badge">${p.bhk || 'N/A'} BHK</span>
                        <h3 style="margin:5px 0 2px; font-size:16px; color:#333;">${p.title || 'Untitled'}</h3>
                    </div>
                    <span style="font-size:10px; color:#2e7d32; font-weight:bold; border:1px solid #2e7d32; padding:2px 6px; border-radius:4px;">${p.type || 'SELL'}</span>
                </div>
                <p class="price-tag">‚Çπ ${Number(p.price || 0).toLocaleString('en-IN')}</p>
                <p class="loc-tag"><i class="material-icons" style="font-size:14px;">place</i> ${p.location || 'Unknown'}</p>
                
                ${isMine ? `
                    <div class="manage-btns">
                        <button class="btn-edit" onclick="location.href='edit.html?id=${p.id}'">EDIT</button>
                        <button class="btn-del" onclick="delPost('${p.id}')">DELETE</button>
                    </div>
                ` : `
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <a href="tel:${cleanPhone}" style="flex:1; background:#2e7d32; color:white; text-align:center; padding:12px; border-radius:12px; text-decoration:none; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:5px;">
                            <i class="material-icons" style="font-size:18px;">call</i> CALL
                        </a>
                        <a href="${waLink}" target="_blank" style="flex:1; background:#25D366; color:white; text-align:center; padding:12px; border-radius:12px; text-decoration:none; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:5px;">
                            <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" style="width:18px; filter:invert(1);"> WHATSAPP
                        </a>
                    </div>
                `}
            </div>`;
        container.appendChild(card);
    });
}

// --- INSTANT FILTER ENGINE ---
const filters = ['searchInput', 'filterType', 'filterBHK', 'filterPrice'];
filters.forEach(id => {
    document.getElementById(id).oninput = () => {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const type = document.getElementById('filterType').value;
        const bhk = document.getElementById('filterBHK').value;
        const priceR = document.getElementById('filterPrice').value.split('-');
        
        const filtered = allPostsCache.filter(p => {
            const title = (p.title || "").toLowerCase();
            const loc = (p.location || "").toLowerCase();
            const price = parseInt(p.price) || 0;
            const matchS = title.includes(query) || loc.includes(query);
            const matchT = (type === "All" || p.type === type);
            const matchB = (bhk === "All" || (!p.bhk && bhk === "All") || p.bhk == bhk);
            const matchP = (price >= parseInt(priceR[0]) && price <= parseInt(priceR[1]));
            return matchS && matchT && matchB && matchP;
        });
        renderList(filtered, document.getElementById("feedAll"), false);
    };
});

// --- NAVIGATION & UI ---
function tab(id, el) {
    if(id === 'profileSec' && !auth.currentUser) { location.href='login.html'; return; }
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active');
    document.getElementById('filterUI').style.display = (id === 'homeSec') ? 'block' : 'none';
    if(id === 'profileSec') loadMy();
}

function goPost() { auth.currentUser ? location.href='upload.html' : location.href='login.html'; }

// --- GALLERY & DELETE ---
let lastScrollY = 0;
function openGal(json){
    lastScrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${lastScrollY}px`;
    document.body.style.width = '100%';
    const list = JSON.parse(decodeURIComponent(json));
    document.getElementById("gallerySlider").innerHTML = list.map(i => `<div class="gallery-item"><img src="${i}"></div>`).join("");
    document.getElementById("gallery").style.display = "block";
}

function closeGal(){
    document.getElementById("gallery").style.display="none";
    document.body.style.position = '';
    window.scrollTo(0, lastScrollY);
}

async function delPost(id) {
    if(!confirm("Are you sure?")) return;
    try {
        const docRef = db.collection("properties").doc(id);
        const snap = await docRef.get();
        const paths = snap.data().storagePaths || [];
        await Promise.all(paths.map(path => firebase.storage().ref(path).delete().catch(e=>{})));
        await docRef.delete();
        document.getElementById("c-"+id).remove();
    } catch(e) { alert("Error deleting post"); }
}

function logout() { if(confirm("Logout?")) auth.signOut().then(()=> location.reload()); }
</script>
</body>
</html>
