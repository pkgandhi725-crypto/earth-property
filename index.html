// --- 3. GALLERY ZOOM & PAN PHYSICS (ULTIMATE FIX) ---
function openGallery(json) {
    galleryImgs = JSON.parse(decodeURIComponent(json));
    const slider = document.getElementById("gallerySlider");
    slider.innerHTML = galleryImgs.map(src => `<div class="gallery-item"><img src="${src}" class="zoomable"></div>`).join("");
    document.getElementById("gallery").style.display = "block";
    updateCounter(0);
    initZoom(); 
}

function initZoom() {
    const imgs = document.querySelectorAll('.zoomable');
    imgs.forEach(img => {
        let lastTap = 0;
        let scale = 1;
        let pointX = 0;
        let pointY = 0;
        let startX = 0;
        let startY = 0;
        let isPanning = false;

        img.addEventListener('touchstart', e => {
            if (e.touches.length === 1 && scale > 1) {
                isPanning = true;
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
            } else if (e.touches.length === 2) {
                isPanning = false;
                initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            }
        });

        img.addEventListener('touchmove', e => {
            if (e.touches.length === 1 && isPanning) {
                e.preventDefault();
                pointX = e.touches[0].clientX - startX;
                pointY = e.touches[0].clientY - startY;
                img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            } else if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                scale = Math.min(Math.max(1, (dist / initialDist) * scale), 4);
                img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                document.getElementById("gallerySlider").style.overflowX = scale > 1.1 ? "hidden" : "auto";
            }
        });

        img.addEventListener('touchend', e => {
            isPanning = false;
            
            // Double Tap to Toggle Zoom
            let now = new Date().getTime();
            if (now - lastTap < 300) {
                if (scale > 1.1) {
                    scale = 1; pointX = 0; pointY = 0;
                    img.style.transform = `translate(0,0) scale(1)`;
                    document.getElementById("gallerySlider").style.overflowX = "auto";
                } else {
                    scale = 2.5;
                    img.style.transform = `translate(0,0) scale(2.5)`;
                    document.getElementById("gallerySlider").style.overflowX = "hidden";
                }
            }
            lastTap = now;
        });
    });
}
