<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Earth Property - Final Pro</title>
<style>
/* üé® UI & Feed Styles */
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px;-webkit-tap-highlight-color:transparent;}
header{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;}
#userBox{font-size:12px;opacity:.9;margin:0}
.profile-img{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover;cursor:pointer}
.card{background:white;margin:12px;padding:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative;animation:fadeIn 0.5s ease;}
@keyframes fadeIn {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;gap:8px}
.slider::-webkit-scrollbar{display:none}
.slider img{min-width:100%;scroll-snap-align:center;border-radius:12px;height:230px;object-fit:cover;cursor:pointer;background:#eee}

/* üîÑ Spinner */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #2e7d32;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* üñºÔ∏è üî• PRO GALLERY (The 100% Physics Fix) */
#gallery{position:fixed;inset:0;background:black;display:none;z-index:9999;overflow:hidden}

#gallerySlider {
  display: flex;
  height: 100vh;
  width: 100vw;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scrollbar-width: none;
  scroll-behavior: smooth;
  touch-action: pan-x pan-y;
}
#gallerySlider::-webkit-scrollbar{display:none}

.gallery-item {
  flex: 0 0 100vw;
  width: 100vw;
  height: 100vh;
  scroll-snap-align: center;
  scroll-snap-stop: always;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden; 
  touch-action: pan-x pan-y;
  overscroll-behavior: contain;
}

.gallery-item::before {
  content:"";
  position:absolute;
  inset:0;
  background:black;
  z-index:-1;
}

.gallery-item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: transform .25s ease;
  transform-origin: center center;
}

#galleryCounter{position:absolute;top:25px;left:20px;color:white;background:rgba(0,0,0,.6);padding:6px 14px;border-radius:20px;z-index:10001;font-weight:600}
#galleryClose{position:absolute;top:25px;right:20px;background:#2e7d32;color:white;border:none;width:44px;height:44px;border-radius:50%;font-size:28px;z-index:10001;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* ‚ö° Actions */
.action-row{display:flex;justify-content:space-between;gap:4px;margin-top:12px}
.action{flex:1 1 20%;min-width:0;height:56px;border-radius:14px;background:#f5f5f5;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;text-decoration:none;color:#444;transition:0.2s;cursor:pointer}
.action span{margin-top:2px;font-weight:600;white-space:nowrap}
.call{background:#e3f2fd} .whatsapp{background:#e8f5e9} .chat{background:#f3e5f5} .share{background:#e0f2f1} .report{background:#ffebee}
.action:disabled{opacity:0.5;cursor:not-allowed}
</style>
</head>
<body>

<header>
  <div><h3 style="margin:0">Earth Property</h3><p id="userBox">Connecting...</p></div>
  <img id="profileBtn" class="profile-img" src="https://via.placeholder.com/40" alt="Profile">
</header>

<div id="list"></div>

<div id="gallery">
 <div id="galleryCounter">1/1</div>
 <button id="galleryClose" onclick="closeGallery()">√ó</button>
 <div id="gallerySlider"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// üî• Firebase Setup
firebase.initializeApp({ 
    apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain:"earth-properties-c3c56.firebaseapp.com", 
    projectId:"earth-properties-c3c56"
});
const db = firebase.firestore(); 
const auth = firebase.auth();

// üéØ Global Variables
let galleryImgs = [], currentIndex = 0, zoom = 1, activeImg = null, lastTap = 0;
let panX = 0, panY = 0, panStartX = 0, panStartY = 0;

// --- 1. INITIALIZATION & AUTH CHECK ---
// ‚úÖ FIX #1: Safer auth check (prevents race condition redirects)
auth.onAuthStateChanged(u => {
    const userBox = document.getElementById("userBox");
    const profileBtn = document.getElementById("profileBtn");

    if (!u) {
        // ‚è≥ Wait 1 second before redirect (fixes GitHub Pages race bug)
        setTimeout(() => {
            if (!auth.currentUser) location.href = "login.html";
        }, 1000);
        return;
    }

    const name = u.displayName || (u.email ? u.email.split('@')[0] : "User");

    if (userBox) userBox.textContent = "üë§ " + name;

    if (profileBtn) {
        profileBtn.src = u.photoURL || 
          `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=2e7d32&color=fff`;
    }

    loadProperties();
});

// ‚úÖ Profile Button Logout Handler
document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById("profileBtn")?.addEventListener("click", ()=>{
        if(confirm("Do you want to logout?")) {
            auth.signOut().then(()=> location.href="login.html");
        }
    });
});

// --- 2. LOAD PROPERTIES (Core Engine) ---
async function loadProperties() {
    const list = document.getElementById("list");
    if (!list) return;

    try {
        list.innerHTML = `<center style="padding:50px;color:#666">
            <div class="spinner"></div><br>üîç Finding best properties...
        </center>`;

        // ‚úÖ Safe query with limit (prevents timestamp crash)
        const qs = await db
            .collection("properties")
            .orderBy("timestamp", "desc")
            .limit(50)
            .get();

        if (qs.empty) {
            list.innerHTML = `<center style="padding:50px;color:#999">üì≠ No properties listed yet.</center>`;
            return;
        }

        list.innerHTML = "";

        qs.forEach(doc => {
            const d = doc.data();
            const imgs = d.images || [];
            const json = encodeURIComponent(JSON.stringify(imgs));
            const docId = doc.id;

            // ‚úÖ XSS Protection
            const title = escapeHtml(d.title || "Untitled Property");
            const price = escapeHtml(d.price || "Contact for Price");
            const location = escapeHtml(d.location || "Location not specified");
            const phone = d.phone || "";

            list.innerHTML += `
                <div class="card" id="card-${docId}">
                    <div class="slider">
                        ${imgs.length > 0 
                            ? imgs.map(i => `<img src="${escapeHtml(i)}" onclick="openGallery('${json}')" loading="lazy" alt="Property">`).join("")
                            : `<img src="https://placehold.co/600x400?text=No+Image" style="filter:grayscale(1)" alt="No image">`
                        }
                    </div>

                    <div style="padding:15px">
                        <h3 style="margin:0 0 8px; color:#333; font-size:18px">${title}</h3>
                        <p style="margin:0; color:#2e7d32; font-weight:bold; font-size:16px">‚Çπ ${price}</p>
                        <p style="margin:5px 0 15px; color:#666; font-size:13px">üìç ${location}</p>

                        <div class="action-row">
                            ${phone 
                                ? `<a class="action call" href="tel:${phone}">üìû <span>Call</span></a>
                                   <a class="action whatsapp" href="https://wa.me/${phone}?text=Hi, I'm interested in: ${encodeURIComponent(title)}">üí¨ <span>WhatsApp</span></a>`
                                : `<button class="action call" disabled>üìû <span>No Contact</span></button>
                                   <button class="action whatsapp" disabled>üí¨ <span>No Contact</span></button>`
                            }
                            <a class="action chat" href="chat.html?id=${docId}${d.ownerId ? '&to=' + escapeHtml(d.ownerId) : ''}" 
                               onclick="return ${d.ownerId ? 'true' : 'alert(\'Owner info not available\'); false'};">
                                üó®Ô∏è <span>Chat</span>
                            </a>
                            <button class="action share" onclick="shareMe('${title.replace(/'/g, "\\'")}', '${docId}')">
                                üì§ <span>Share</span>
                            </button>
                            <button class="action report" onclick="reportPost('${docId}')">
                                üö©
                            </button>
                        </div>
                    </div>
                </div>`;
        });
    } catch (e) {
        console.error("Critical Error:", e);
        list.innerHTML = `
            <center style="padding:50px;color:red">
                ‚ö†Ô∏è Connection failed<br>
                <small style="color:#999">${e.message}</small><br><br>
                <button onclick="loadProperties()" style="background:#2e7d32; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer">üîÑ Retry Connection</button>
            </center>`;
    }
}

// --- 3. GALLERY FUNCTIONS ---
function openGallery(json) {
    galleryImgs = JSON.parse(decodeURIComponent(json));
    const gallery = document.getElementById("gallery");
    const slider = document.getElementById("gallerySlider");
    
    if(!gallery || !slider) return;
    
    slider.innerHTML = "";
    galleryImgs.forEach((src, idx) => {
        const frame = document.createElement("div");
        frame.className = "gallery-item";
        frame.innerHTML = `<img src="${src}" alt="Image ${idx+1}">`;
        slider.appendChild(frame);
    });
    
    gallery.style.display = "block";
    document.body.style.overflow = "hidden";
    currentIndex = 0;
    updateGalleryCounter();
}

function closeGallery() {
    document.getElementById("gallery").style.display = "none";
    document.body.style.overflow = "auto";
    resetGallery();
}

function resetGallery() {
    zoom = 1; panX = 0; panY = 0; activeImg = null; currentIndex = 0;
    const slider = document.getElementById("gallerySlider");
    slider.style.overflowX = "auto";
    slider.style.scrollSnapType = "x mandatory";
    slider.scrollLeft = 0;
    document.querySelectorAll('.gallery-item img').forEach(i => i.style.transform = 'scale(1) translate(0,0)');
}

function updateGalleryCounter() {
    const counter = document.getElementById("galleryCounter");
    if(counter) counter.textContent = `${currentIndex + 1} / ${galleryImgs.length}`;
}

// üîÑ Gallery Physics Engine
const gallerySlider = document.getElementById("gallerySlider");

gallerySlider.addEventListener("touchstart", e => {
    if(e.target.tagName === "IMG") {
        activeImg = e.target;
        if(zoom > 1) {
            panStartX = e.touches[0].clientX - panX;
            panStartY = e.touches[0].clientY - panY;
        }
    }
});

gallerySlider.addEventListener("touchmove", e => {
    if(!activeImg) return;

    if(e.touches.length === 2) {
        e.preventDefault();
        const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        zoom = Math.min(Math.max(1, d/180), 4);
        
        gallerySlider.style.scrollSnapType = zoom > 1 ? "none" : "x mandatory";
        gallerySlider.style.overflowX = zoom > 1 ? "hidden" : "auto";

        activeImg.style.transform = `scale(${zoom}) translate(${panX/zoom}px, ${panY/zoom}px)`;
    } 
    else if(zoom > 1) {
        e.preventDefault();
        panX = Math.max(Math.min(e.touches[0].clientX - panStartX, 400), -400);
        panY = Math.max(Math.min(e.touches[0].clientY - panStartY, 400), -400);
        activeImg.style.transform = `scale(${zoom}) translate(${panX/zoom}px, ${panY/zoom}px)`;
    }
}, {passive: false});

gallerySlider.addEventListener("touchend", e => {
    const now = Date.now();
    if(now - lastTap < 300 && e.target.tagName === 'IMG') {
        zoom = (zoom === 1) ? 2.5 : 1;
        if(zoom === 1) resetGallery();
        else {
            gallerySlider.style.scrollSnapType = "none";
            gallerySlider.style.overflowX = "hidden";
            e.target.style.transform = `scale(2.5)`;
        }
    }
    lastTap = now;
});

// ‚úÖ FIX #2: Android scroll index fix (prevents fractional scroll bugs)
gallerySlider.addEventListener("scroll", e => {
    currentIndex = Math.floor((e.target.scrollLeft + 10) / window.innerWidth);
    updateGalleryCounter();
});

// --- 4. HELPER FUNCTIONS ---

// ‚úÖ XSS Protection
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Share Feature
async function shareMe(title, id) {
    const shareData = {
        title: title,
        text: `Check out this property: ${title}`,
        url: window.location.href.split('?')[0] + "?id=" + id
    };
    try {
        if (navigator.share) {
            await navigator.share(shareData);
        } else {
            navigator.clipboard.writeText(shareData.url);
            alert("‚úÖ Link copied to clipboard!");
        }
    } catch (err) { 
        console.log("Share failed:", err); 
    }
}

// Report Logic
function reportPost(id) {
    if(confirm("Do you want to report this property?")) {
        alert("‚úÖ Thank you. Our team will review property ID: " + id);
        // TODO: Send report to Firebase
    }
}
</script>
</body>
</html>
