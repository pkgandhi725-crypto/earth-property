<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Earth Property - Final Pro</title>
<style>
/* üé® UI & Feed Styles */
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px;-webkit-tap-highlight-color:transparent;}
header{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;}
#userBox{font-size:12px;opacity:.9;margin:0}
.profile-img{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover;cursor:pointer}
.card{background:white;margin:12px;padding:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative;animation:fadeIn 0.5s ease;}
@keyframes fadeIn {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;gap:8px}
.slider::-webkit-scrollbar{display:none}
.slider img{min-width:100%;scroll-snap-align:center;border-radius:12px;height:230px;object-fit:cover;cursor:pointer;background:#eee}

/* üîÑ Spinner */
.spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #2e7d32; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* üñºÔ∏è GALLERY UI */
#gallery{position:fixed;inset:0;background:black;display:none;z-index:9999;overflow:hidden}
#gallerySlider { display: flex; height: 100vh; width: 100vw; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; touch-action: pan-x pan-y; }
#gallerySlider::-webkit-scrollbar{display:none}
.gallery-item { flex: 0 0 100vw; width: 100vw; height: 100vh; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; background:black; }
.gallery-item img { width: 100%; height: 100%; object-fit: contain; }
#galleryCounter{position:absolute;top:25px;left:20px;color:white;background:rgba(0,0,0,.6);padding:6px 14px;border-radius:20px;z-index:10001;}
#galleryClose{position:absolute;top:25px;right:20px;background:#2e7d32;color:white;border:none;width:44px;height:44px;border-radius:50%;font-size:28px;z-index:10001;cursor:pointer}

/* ‚ö° Actions */
.action-row{display:flex;justify-content:space-between;gap:6px;margin-top:12px}
.action{flex:1; height:54px;border-radius:12px;background:#f5f5f5;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;text-decoration:none;color:#444;cursor:pointer}
.action span{margin-top:2px;font-weight:600;}
.call{background:#e3f2fd; color:#0d47a1} .whatsapp{background:#e8f5e9; color:#1b5e20} .chat{background:#f3e5f5; color:#4a148c} .share{background:#e0f2f1; color:#004d40} .report{background:#ffebee; flex:0 0 40px}
</style>
</head>
<body>

<header>
  <div><h3 style="margin:0">Earth Property</h3><p id="userBox">Connecting...</p></div>
  <img id="profileBtn" class="profile-img" src="https://ui-avatars.com/api/?name=User" alt="Profile">
</header>

<div id="list"></div>

<div id="gallery">
 <div id="galleryCounter">1/1</div>
 <button id="galleryClose" onclick="closeGallery()">√ó</button>
 <div id="gallerySlider"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// üî• Firebase Setup
const firebaseConfig = { 
    apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain:"earth-properties-c3c56.firebaseapp.com", 
    projectId:"earth-properties-c3c56"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(); 
const auth = firebase.auth();

let galleryImgs = [];

// --- 1. AUTH LOGIC ---
auth.onAuthStateChanged(u => {
    const userBox = document.getElementById("userBox");
    const profileBtn = document.getElementById("profileBtn");

    if (u) {
        const name = u.displayName || u.email.split('@')[0] || "User";
        if (userBox) userBox.textContent = "üë§ " + name;
        if (profileBtn) {
            profileBtn.src = u.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=2e7d32&color=fff`;
        }
        loadProperties();
    } else {
        // Redirect to login if not authenticated
        setTimeout(() => { if(!auth.currentUser) location.href = "login.html"; }, 1500);
    }
});

// Logout feature
document.getElementById("profileBtn").onclick = () => {
    if(confirm("Logout from Earth Property?")) auth.signOut().then(() => location.href="login.html");
};

// --- 2. CORE DATA LOAD ---
async function loadProperties() {
    const list = document.getElementById("list");
    try {
        list.innerHTML = `<center style="padding:50px;"><div class="spinner"></div><p>Searching Properties...</p></center>`;
        
        // Note: If this fails, click the link in browser console to create Firestore Index
        const qs = await db.collection("properties").orderBy("timestamp", "desc").limit(40).get();
        
        if (qs.empty) {
            list.innerHTML = `<center style="padding:50px;color:#999">No properties found.</center>`;
            return;
        }

        list.innerHTML = "";
        qs.forEach(doc => {
            const d = doc.data();
            const imgs = d.images || [];
            const docId = doc.id;
            const phone = d.phone ? d.phone.replace(/\D/g,'') : ""; // Clean phone for links

            list.innerHTML += `
                <div class="card">
                    <div class="slider">
                        ${imgs.length > 0 
                            ? imgs.map(i => `<img src="${i}" onclick="openGallery('${encodeURIComponent(JSON.stringify(imgs))}')" loading="lazy">`).join("")
                            : `<img src="https://via.placeholder.com/400x250?text=No+Image+Available">`
                        }
                    </div>
                    <div style="padding:5px">
                        <h3 style="margin:10px 0 5px; color:#222">${d.title || 'Untitled'}</h3>
                        <p style="margin:0; color:#2e7d32; font-weight:bold">‚Çπ ${d.price || 'N/A'}</p>
                        <p style="margin:5px 0 15px; color:#666; font-size:13px">üìç ${d.location || 'Unknown'}</p>

                        <div class="action-row">
                            <a class="action call" href="tel:${phone}">üìû<span>Call</span></a>
                            <a class="action whatsapp" href="https://wa.me/${phone}?text=I'm interested in ${encodeURIComponent(d.title)}">üí¨<span>WhatsApp</span></a>
                            <a class="action chat" href="chat.html?id=${docId}&to=${d.ownerId || ''}">üó®Ô∏è<span>Chat</span></a>
                            <button class="action share" onclick="shareMe('${d.title}', '${docId}')">üì§<span>Share</span></button>
                            <button class="action report" onclick="reportPost('${docId}')">üö©</button>
                        </div>
                    </div>
                </div>`;
        });
    } catch (e) {
        list.innerHTML = `<center style="padding:50px;color:red">‚ö†Ô∏è Connection Error<br><button onclick="loadProperties()" style="margin-top:10px">Retry</button></center>`;
        console.error(e);
    }
}

// --- 3. GALLERY & UTILS ---
function openGallery(json) {
    galleryImgs = JSON.parse(decodeURIComponent(json));
    const slider = document.getElementById("gallerySlider");
    slider.innerHTML = galleryImgs.map(src => `<div class="gallery-item"><img src="${src}"></div>`).join("");
    document.getElementById("gallery").style.display = "block";
    updateCounter(0);
}

function closeGallery() { document.getElementById("gallery").style.display = "none"; }

document.getElementById("gallerySlider").onscroll = (e) => {
    const idx = Math.round(e.target.scrollLeft / window.innerWidth);
    updateCounter(idx);
};

function updateCounter(i) {
    document.getElementById("galleryCounter").textContent = `${i + 1} / ${galleryImgs.length}`;
}

async function shareMe(title, id) {
    const url = window.location.origin + window.location.pathname + "?id=" + id;
    if (navigator.share) {
        navigator.share({ title: title, url: url });
    } else {
        navigator.clipboard.writeText(url);
        alert("Link Copied!");
    }
}

function reportPost(id) {
    alert("Property " + id + " has been reported for review.");
}
</script>
</body>
</html>
