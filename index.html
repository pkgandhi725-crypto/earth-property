<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Earth Property - Pro Fix</title>

<style>
/* üé® UI & Feed */
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px;-webkit-tap-highlight-color:transparent;overflow-x:hidden}
header{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;}
.profile-img{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover}
.card{background:white;margin:12px;padding:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative}

/* üì∏ Home Feed Slider */
.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;gap:8px}
.slider::-webkit-scrollbar{display:none}
.slider img{min-width:100%;scroll-snap-align:center;border-radius:12px;height:230px;object-fit:cover;background:#eee}

/* üñºÔ∏è üî• ULTIMATE GALLERY FIX */
#gallery{position:fixed;inset:0;background:black;display:none;z-index:9999;overflow:hidden}
#gallerySlider {
  display: flex;
  height: 100vh;
  width: 100vw;
  overflow-x: auto;
  scroll-snap-type: x mandatory; /* Default snap on */
  scrollbar-width: none;
  scroll-behavior: smooth;
}
#gallerySlider::-webkit-scrollbar{display:none;}

.gallery-item {
  flex: 0 0 100vw;
  width: 100vw;
  height: 100vh;
  scroll-snap-align: center;
  scroll-snap-stop: always;
  display: flex;
  align-items: center;
  justify-content: center;
  background: black;
  overflow: hidden;
  padding: 0 5px; /* Photos ke beech halka gap */
  box-sizing: border-box;
}

#gallerySlider img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  touch-action: none; /* JS handle karega zoom ko */
  transition: transform 0.2s ease-out;
}

#galleryCounter{position:absolute;top:25px;left:20px;color:white;background:rgba(0,0,0,.6);padding:6px 14px;border-radius:20px;z-index:10001;font-weight:600}
#galleryClose{position:absolute;top:25px;right:20px;background:#2e7d32;color:white;border:none;width:44px;height:44px;border-radius:50%;font-size:28px;z-index:10001;display:flex;align-items:center;justify-content:center}

/* ‚ö° Actions */
.action-row{display:flex;justify-content:space-between;gap:4px;margin-top:12px}
.action{flex:1 1 20%;min-width:0;height:56px;border-radius:14px;background:#f5f5f5;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;text-decoration:none;color:#444}
.action span{margin-top:2px;font-weight:600}
.call{background:#e3f2fd} .whatsapp{background:#e8f5e9} .chat{background:#f3e5f5} .share{background:#e0f2f1} .report{background:#ffebee}
</style>
</head>
<body>

<header>
  <div><h3 style="margin:0">Earth Property</h3><p id="userBox" style="font-size:11px;margin:0;opacity:0.8">Connecting...</p></div>
  <img id="profileBtn" class="profile-img" src="https://via.placeholder.com/40">
</header>

<div id="list"></div>

<div id="gallery">
 <div id="galleryCounter">1/1</div>
 <button id="galleryClose" onclick="closeGallery()">√ó</button>
 <div id="gallerySlider"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
});
const db=firebase.firestore(); const auth=firebase.auth();

let galleryImgs=[], zoom=1, lastTap=0, moveX=0, moveY=0, startX=0, startY=0, startDist=0, isZoomed=false;

// üñºÔ∏è OPEN GALLERY
function openGallery(json){
 galleryImgs=JSON.parse(decodeURIComponent(json));
 const g=document.getElementById("gallerySlider");
 g.innerHTML="";
 galleryImgs.forEach(src=>{
  const div=document.createElement("div");
  div.className="gallery-item";
  div.innerHTML=`<img src="${src}">`;
  g.appendChild(div);
 });
 document.getElementById("galleryCounter").innerText=`1 / ${galleryImgs.length}`;
 document.getElementById("gallery").style.display="block";
}

function closeGallery(){
 document.getElementById("gallery").style.display="none";
 resetZoom();
}

function resetZoom(){
 zoom=1; moveX=0; moveY=0; isZoomed=false;
 const slider = document.getElementById("gallerySlider");
 slider.style.scrollSnapType = "x mandatory"; // Snap vapas chalu
 Array.from(slider.querySelectorAll("img")).forEach(img=>img.style.transform=`scale(1) translate(0,0)`);
}

// üîÑ SLIDER & ZOOM LOGIC
const slider = document.getElementById("gallerySlider");

slider.addEventListener("scroll", ()=>{
 if(!isZoomed){
  const idx = Math.round(slider.scrollLeft / window.innerWidth);
  document.getElementById("galleryCounter").innerText = `${idx+1} / ${galleryImgs.length}`;
 }
});

slider.addEventListener("touchstart", e=>{
 if(e.touches.length === 2){
  startDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
 } else {
  startX = e.touches[0].clientX - moveX;
  startY = e.touches[0].clientY - moveY;
 }
});

slider.addEventListener("touchmove", e=>{
 const img = e.target;
 if(img.tagName !== 'IMG') return;

 if(e.touches.length === 2){
  e.preventDefault();
  const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
  zoom = Math.min(Math.max(1, (dist / startDist)), 4);
 } 
 else if (zoom > 1) {
  e.preventDefault();
  moveX = e.touches[0].clientX - startX;
  moveY = e.touches[0].clientY - startY;
 }

 if(zoom > 1) {
  isZoomed = true;
  slider.style.scrollSnapType = "none"; // üî• ZOOM TIME PAR SNAP BAND
  img.style.transform = `scale(${zoom}) translate(${moveX/zoom}px, ${moveY/zoom}px)`;
 } else {
  resetZoom();
 }
}, {passive: false});

slider.addEventListener("touchend", e=>{
 const now = Date.now();
 if(now - lastTap < 300 && e.target.tagName === 'IMG'){
  if(zoom > 1) resetZoom();
  else {
    zoom = 2.5; isZoomed = true;
    slider.style.scrollSnapType = "none";
    e.target.style.transform = `scale(2.5)`;
  }
 }
 lastTap = now;
});

// üè† LOAD DATA
async function loadProperties(){
 const qs=await db.collection("properties").orderBy("timestamp","desc").get();
 const list=document.getElementById("list"); list.innerHTML="";
 qs.forEach(doc=>{
  const d=doc.data(); const imgs=d.images||[]; const json=encodeURIComponent(JSON.stringify(imgs));
  list.innerHTML+=`
   <div class="card">
    <div class="slider">${imgs.map(i=>`<img src="${i}" onclick="openGallery('${json}')">`).join("")}</div>
    <h3>${d.title}</h3><p>üìç ${d.location} | üí∞ ‚Çπ${d.price}</p>
    <div class="action-row">
     <a class="action call" href="tel:${d.phone}">üìû<span>Call</span></a>
     <a class="action whatsapp" href="https://wa.me/${d.phone}?text=Hi">üí¨<span>WhatsApp</span></a>
     <button class="action chat">üó®<span>Chat</span></button>
     <button class="action share" onclick="navigator.share({title:'${d.title}',url:window.location.href})">üì§<span>Share</span></button>
     <button class="action report">üö©<span>Report</span></button>
    </div>
   </div>`;
 });
}
auth.onAuthStateChanged(u=> { if(u) loadProperties(); else location.href="login.html"; });
</script>
</body>
</html>
