<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Earth Property</title>
<link rel="manifest" href="/earth-property/manifest.json">
<meta name="theme-color" content="#2e7d32">

<style>
/* üé® UI Styles */
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px}
header{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
#userBox{font-size:12px;opacity:.9;margin:0}
.profile-img{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover;cursor:pointer}
.card{background:white;margin:12px;padding:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative}
.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none}
.slider::-webkit-scrollbar{display:none}
.slider img{min-width:100%;scroll-snap-align:center;border-radius:12px;height:220px;object-fit:cover;cursor:pointer;background:#eee}

/* üñºÔ∏è Premium Gallery Styles */
#gallery{position:fixed;inset:0;background:black;display:none;z-index:9999;overflow:hidden}
#gallerySlider{display:flex;height:100vh;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none}
#gallerySlider img{min-width:100%;height:100vh;object-fit:contain;touch-action:none;transition:transform 0.1s ease-out;cursor:zoom-in}
#galleryClose{position:absolute;top:20px;right:20px;background:#2e7d32;color:white;border:none;width:44px;height:44px;border-radius:50%;font-size:28px;z-index:10001;box-shadow:0 4px 10px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
#galleryCounter{position:absolute;top:20px;left:20px;color:white;background:rgba(0,0,0,.6);padding:6px 14px;border-radius:20px;font-size:14px;z-index:10001;font-weight:600}

/* ‚ö° Action Buttons */
.action-row{display:flex;justify-content:space-between;gap:4px;margin-top:12px}
.action{flex:1 1 20%;min-width:0;height:56px;border-radius:14px;background:#f5f5f5;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;text-decoration:none;color:#444}
.action span{margin-top:2px;font-weight:600;white-space:nowrap}
.fav-badge{position:absolute;top:20px;right:20px;background:white;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.25);font-size:18px;z-index:10}
.call{background:#e3f2fd} .whatsapp{background:#e8f5e9} .chat{background:#f3e5f5} .share{background:#e0f2f1} .report{background:#ffebee}

/* üí¨ Chat Box */
#chatBox{position:fixed;bottom:0;left:0;right:0;background:white;display:none;z-index:1000;border-top:3px solid #2e7d32;border-radius:15px 15px 0 0}
#chatHeader{background:#2e7d32;color:white;padding:12px;display:flex;justify-content:space-between}
#chatMessages{max-height:280px;overflow:auto;padding:12px;background:#f9f9f9}
.msg{padding:8px 12px;background:#e0f2f1;border-radius:12px;margin:5px 0;max-width:80%;font-size:14px}
</style>
</head>
<body>

<header>
  <div><h3 style="margin:0">Earth Property</h3><p id="userBox">Connecting...</p></div>
  <img id="profileBtn" class="profile-img" src="https://via.placeholder.com/40" onclick="location.href='profile.html'">
</header>

<div class="card" style="text-align:center; padding:15px">
  <a href="post.html" style="background:#2e7d32;color:white;padding:10px 20px;border-radius:25px;text-decoration:none;font-weight:600">‚ûï Post Property</a>
</div>

<div id="list"></div>

<div id="gallery">
 <div id="galleryCounter">1/1</div>
 <button id="galleryClose" onclick="closeGallery()">√ó</button>
 <div id="gallerySlider"></div>
</div>

<div id="chatBox">
 <div id="chatHeader"><span style="font-weight:600">üó® Chat</span><button onclick="closeChat()" style="color:white;background:none;border:none;font-size:24px">√ó</button></div>
 <div id="chatMessages"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
});
const db=firebase.firestore(); const auth=firebase.auth();

let currentUser=null, currentChatId=null, galleryImgs=[], currentIndex=0;
let zoom=1, lastTap=0, startDist=0, moveX=0, moveY=0, startX=0, startY=0, swipeY=0;

// üü¢ AUTH
auth.onAuthStateChanged(async u=>{
 if(!u) location.href="login.html";
 else {
  currentUser=u; document.getElementById("userBox").innerText="üë§ "+u.email;
  loadProperties();
 }
});

// üñºÔ∏è GALLERY ENGINE
function openGallery(json){
 galleryImgs=JSON.parse(decodeURIComponent(json));
 const g=document.getElementById("gallerySlider");
 g.innerHTML=""; currentIndex=0;
 galleryImgs.forEach((src, i)=>{
  const img=document.createElement("img");
  img.src=src; img.dataset.index=i;
  g.appendChild(img);
 });
 document.getElementById("galleryCounter").innerText=`1 / ${galleryImgs.length}`;
 document.getElementById("gallery").style.display="block";
 document.body.style.overflow="hidden";
}

function closeGallery(){
 document.getElementById("gallery").style.display="none";
 document.body.style.overflow="auto";
 zoom=1; moveX=0; moveY=0;
}

// üîÑ Update Counter
document.getElementById("gallerySlider").addEventListener("scroll", e=>{
 const idx = Math.round(e.target.scrollLeft / e.target.clientWidth);
 document.getElementById("galleryCounter").innerText = `${idx+1} / ${galleryImgs.length}`;
});

// üñêÔ∏è TOUCH LOGIC (Pinch, Drag, Double-Tap, Swipe-Down)
document.getElementById("gallerySlider").addEventListener("touchstart", e=>{
 swipeY = e.touches[0].clientY;
 if(e.touches.length==2){
  startDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
 } else {
  startX = e.touches[0].clientX - moveX;
  startY = e.touches[0].clientY - moveY;
 }
},{passive:true});

document.getElementById("gallerySlider").addEventListener("touchmove", e=>{
 const img = e.target;
 if(e.touches.length==2){
  const dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
  zoom = Math.min(Math.max(1, dist/startDist), 4);
  img.style.transform = `scale(${zoom}) translate(${moveX}px, ${moveY}px)`;
 } else if(zoom > 1){
  moveX = (e.touches[0].clientX - startX);
  moveY = (e.touches[0].clientY - startY);
  img.style.transform = `scale(${zoom}) translate(${moveX/zoom}px, ${moveY/zoom}px)`;
 } else {
  if((e.touches[0].clientY - swipeY) > 120) closeGallery();
 }
},{passive:true});

document.getElementById("gallerySlider").addEventListener("touchend", e=>{
 const now = Date.now();
 if(now - lastTap < 300 && e.target.tagName=="IMG"){
  zoom = (zoom === 1) ? 2 : 1;
  moveX=0; moveY=0;
  e.target.style.transform = `scale(${zoom})`;
 }
 lastTap = now;
});

// üè† LOAD & ACTIONS
async function loadProperties(){
 const qs=await db.collection("properties").orderBy("timestamp","desc").get();
 const list=document.getElementById("list"); list.innerHTML="";
 qs.forEach(doc=>{
  const d=doc.data(); const imgs=d.images||[]; const json=encodeURIComponent(JSON.stringify(imgs));
  list.innerHTML+=`
  <div class="card">
   <div class="fav-badge" onclick="toggleFav('${doc.id}')">ü§ç</div>
   <div class="slider">${imgs.map(i=>`<img src="${i}" onclick="openGallery('${json}')">`).join("")}</div>
   <h3>${d.title}</h3><p>üìç ${d.location} | üí∞ ‚Çπ${d.price}</p>
   <div class="action-row">
    <a class="action call" href="tel:${d.phone}">üìû<span>Call</span></a>
    <a class="action whatsapp" href="https://wa.me/${d.phone}?text=Hi">üí¨<span>WhatsApp</span></a>
    <button class="action chat" onclick="openChat('${doc.id}')">üó®<span>Chat</span></button>
    <button class="action share" onclick="window.navigator.share({title:'${d.title}',text:'Check this'})">üì§<span>Share</span></button>
    <button class="action report" onclick="alert('Reported')">üö©<span>Report</span></button>
   </div>
  </div>`;
 });
}

function openChat(id){ document.getElementById("chatBox").style.display="block"; }
function closeChat(){ document.getElementById("chatBox").style.display="none"; }
function toggleFav(id){ alert("Added to Favorites!"); }
</script>
</body>
</html>
