<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Earth Property</title>

<!-- üî• PWA FIX FOR GITHUB PAGES -->
<link rel="manifest" href="/earth-property/manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;}
header{background:#2e7d32;color:white;padding:15px;text-align:center;}
#userBox{font-size:13px;opacity:.9}

.card{
  position:relative;
  background:white;margin:12px;padding:12px;border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
img{width:100%;border-radius:12px;margin-bottom:8px;}
.center{text-align:center;margin:10px;}

.fav-badge{
 position:absolute;top:10px;right:10px;
 background:white;border-radius:50%;
 width:38px;height:38px;
 display:flex;align-items:center;justify-content:center;
 box-shadow:0 2px 6px rgba(0,0,0,.25);
 font-size:18px;cursor:pointer;
}

.action-row{
 display:flex;justify-content:space-between;gap:8px;margin-top:8px;
}
.action{
 flex:1;height:56px;border:none;border-radius:14px;
 font-size:12px;color:#444;cursor:pointer;
 display:flex;flex-direction:column;
 align-items:center;justify-content:center;
 background:#f5f5f5;
}

.action img{width:26px;height:26px;margin-bottom:2px}
.call{background:#e3f2fd;}
.whatsapp{background:#e8f5e9;}
.chat{background:#f3e5f5;}
.share{background:#e0f2f1;}
.report{background:#ffebee;}

#chatBox{
 position:fixed;bottom:0;left:0;right:0;background:white;
 border-top:3px solid #2e7d32;display:none;
 box-shadow:0 -3px 15px rgba(0,0,0,.15);
 border-radius:15px 15px 0 0;
}
#chatHeader{
 background:#2e7d32;color:white;padding:10px;
 display:flex;justify-content:space-between;align-items:center;
}
#chatMessages{
 max-height:220px;overflow:auto;padding:10px;background:#fafafa;
}
.msg{padding:6px 10px;background:#e0f2f1;border-radius:8px;margin:4px 0;}
#chatInputBox{display:flex;border-top:1px solid #ddd;}
#chatInput{flex:1;border:none;padding:10px;font-size:15px;}
#sendBtn{background:#2e7d32;color:white;border:none;padding:0 18px;}
</style>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
<h2>Earth Property</h2>
<p id="userBox">Checking login...</p>
</header>

<div class="center">
<a href="post.html" style="background:#2e7d32;color:white;padding:10px 20px;border-radius:25px;">‚ûï Post Property</a>
<button onclick="logout()" style="background:#f44336;color:white;border:none;padding:10px 20px;border-radius:25px;">Logout</button>
</div>

<div id="list"></div>

<div id="chatBox">
 <div id="chatHeader">
   <span>üí¨ Chat</span>
   <button onclick="closeChat()" style="background:none;border:none;color:white;">‚úñ</button>
 </div>
 <div id="chatMessages"></div>
 <div id="chatInputBox">
   <input id="chatInput" placeholder="Type message...">
   <button id="sendBtn" onclick="sendMsg()">Send</button>
 </div>
</div>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser=null,currentChatId=null;

auth.onAuthStateChanged(user=>{
 if(user){
  currentUser=user;
  userBox.innerText="üë§ "+user.email;
  loadProperties();
 }else location.href="login.html";
});
function logout(){auth.signOut();}

function getFavs(){return JSON.parse(localStorage.getItem("favs")||"[]");}
function toggleFav(id){
 let f=getFavs();
 f=f.includes(id)?f.filter(x=>x!==id):[...f,id];
 localStorage.setItem("favs",JSON.stringify(f));
 loadProperties();
}

function sharePost(t,l,p){
 const text=`${t}\n${l}\nPrice: ${p}\nEarth Property`;
 navigator.share?navigator.share({text}):navigator.clipboard.writeText(text)&&alert("Copied üìã");
}

async function loadProperties(){
 const qs=await db.collection("properties").orderBy("timestamp","desc").get();
 list.innerHTML="";
 const favs=getFavs();
 qs.forEach(doc=>{
  const d=doc.data();
  const fav=favs.includes(doc.id)?"‚ù§Ô∏è":"ü§ç";
  const img=d.images?.[0]||"https://via.placeholder.com/400x250";
  list.innerHTML+=`
  <div class="card">
    <div class="fav-badge" onclick="toggleFav('${doc.id}')">${fav}</div>
    <img src="${img}">
    <h3>${d.title}</h3>
    <p>${d.location} | ‚Çπ${d.price}</p>

    <div class="action-row">
      <a class="action call" href="tel:+${d.phone}">
        <img src="call.svg"><span>Call</span>
      </a>

      <a class="action whatsapp" href="https://api.whatsapp.com/send?phone=${d.phone}">
        <img src="Whatsapp.svg"><span>Whatsapp</span>
      </a>

      <button class="action chat" onclick="openChat('${doc.id}')">üó®<span>Chat</span></button>
      <button class="action share" onclick="sharePost('${d.title}','${d.location}','‚Çπ${d.price}')">üì§<span>Share</span></button>
      <button class="action report" onclick="reportPost('${doc.id}')">üö©<span>Report</span></button>
    </div>
  </div>`;
 });
}

async function reportPost(id){
 await db.collection("properties").doc(id).update({reports:firebase.firestore.FieldValue.increment(1)});
 alert("Reported");
}

function openChat(id){
 currentChatId=id;
 chatBox.style.display="block";
 loadMessages();
}
function closeChat(){chatBox.style.display="none";}

async function sendMsg(){
 const i=chatInput;
 if(!i.value) return;
 await db.collection("chats").doc(currentChatId).collection("messages")
 .add({text:i.value,time:Date.now()});
 i.value="";
}

function loadMessages(){
 db.collection("chats").doc(currentChatId).collection("messages")
 .orderBy("time").onSnapshot(s=>{
  chatMessages.innerHTML="";
  s.forEach(d=>chatMessages.innerHTML+=`<div class="msg">${d.data().text}</div>`);
  chatMessages.scrollTop=chatMessages.scrollHeight;
 });
}
</script>
</body>
</html>
