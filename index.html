<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Earth Property - Final Pro</title>
<style>
/* üé® UI & Feed Styles */
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px;-webkit-tap-highlight-color:transparent;}
header{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;}
#userBox{font-size:12px;opacity:.9;margin:0}
.profile-img{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover;cursor:pointer}
.card{background:white;margin:12px;padding:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative;animation:fadeIn 0.5s ease;}
@keyframes fadeIn {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;gap:8px}
.slider::-webkit-scrollbar{display:none}
.slider img{min-width:100%;scroll-snap-align:center;border-radius:12px;height:230px;object-fit:cover;cursor:pointer;background:#eee}

/* üñºÔ∏è üî• PRO GALLERY (The 100% Physics Fix) */
#gallery{position:fixed;inset:0;background:black;display:none;z-index:9999;overflow:hidden}

#gallerySlider {
  display: flex;
  height: 100vh;
  width: 100vw;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scrollbar-width: none;
  scroll-behavior: smooth;
  touch-action: pan-x pan-y; /* ‚úÖ Bug #1 Fixed */
}

.gallery-item {
  flex: 0 0 100vw;
  width: 100vw;
  height: 100vh;
  scroll-snap-align: center;
  scroll-snap-stop: always;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden; 
  touch-action: pan-x pan-y;   /* ‚úÖ Bug #1 Fixed */
  overscroll-behavior: contain; /* ‚úÖ Bug #3 Fixed */
}

.gallery-item::before {
  content:"";
  position:absolute;
  inset:0;
  background:black;
  z-index:-1;
}

.gallery-item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: transform .25s ease;
  transform-origin: center center;
}

#galleryCounter{position:absolute;top:25px;left:20px;color:white;background:rgba(0,0,0,.6);padding:6px 14px;border-radius:20px;z-index:10001;font-weight:600}
#galleryClose{position:absolute;top:25px;right:20px;background:#2e7d32;color:white;border:none;width:44px;height:44px;border-radius:50%;font-size:28px;z-index:10001;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* ‚ö° Actions */
.action-row{display:flex;justify-content:space-between;gap:4px;margin-top:12px}
.action{flex:1 1 20%;min-width:0;height:56px;border-radius:14px;background:#f5f5f5;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;text-decoration:none;color:#444;transition:0.2s}
.action span{margin-top:2px;font-weight:600;white-space:nowrap}
.call{background:#e3f2fd} .whatsapp{background:#e8f5e9} .chat{background:#f3e5f5} .share{background:#e0f2f1} .report{background:#ffebee}
</style>
</head>
<body>

<header>
  <div><h3 style="margin:0">Earth Property</h3><p id="userBox">Connecting...</p></div>
  <img id="profileBtn" class="profile-img" src="https://via.placeholder.com/40">
</header>

<div id="list"></div>

<div id="gallery">
 <div id="galleryCounter">1/1</div>
 <button id="galleryClose" onclick="closeGallery()">√ó</button>
 <div id="gallerySlider"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Setup
firebase.initializeApp({ apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain:"earth-properties-c3c56.firebaseapp.com", projectId:"earth-properties-c3c56"});
const db=firebase.firestore(); const auth=firebase.auth();

let galleryImgs=[], zoom=1, activeImg=null, lastTap=0;
let panX=0, panY=0, panStartX=0, panStartY=0;

auth.onAuthStateChanged(u=>{ if(u){ loadProperties(); } else { location.href="login.html"; }});

function openGallery(json){
 galleryImgs = JSON.parse(decodeURIComponent(json));
 const g = document.getElementById("gallerySlider");
 g.innerHTML = "";
 galleryImgs.forEach(src=>{
   const frame = document.createElement("div");
   frame.className = "gallery-item";
   frame.innerHTML = `<img src="${src}">`;
   g.appendChild(frame);
 });
 document.getElementById("gallery").style.display="block";
 document.body.style.overflow="hidden";
}

function closeGallery(){
 document.getElementById("gallery").style.display="none";
 document.body.style.overflow="auto";
 resetAll();
}

function resetAll(){
 zoom=1; panX=0; panY=0; activeImg=null;
 const slider = document.getElementById("gallerySlider");
 slider.style.overflowX = "auto";
 slider.style.scrollSnapType = "x mandatory";
 document.querySelectorAll('.gallery-item img').forEach(i => i.style.transform = 'scale(1) translate(0,0)');
}

// üîÑ THE PHYSICS ENGINE (Zoom + Pan + Lock)
const slider = document.getElementById("gallerySlider");

slider.addEventListener("touchstart", e=>{
  if(e.target.tagName==="IMG"){
    activeImg = e.target;
    if(zoom > 1){
      panStartX = e.touches[0].clientX - panX;
      panStartY = e.touches[0].clientY - panY;
    }
  }
});

slider.addEventListener("touchmove", e=>{
  if(!activeImg) return;

  if(e.touches.length===2){
    e.preventDefault();
    const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    zoom=Math.min(Math.max(1, d/180), 4);
    
    // ‚úÖ Bug #2 Fixed: Freeze slider when zoomed
    slider.style.scrollSnapType = zoom > 1 ? "none" : "x mandatory";
    slider.style.overflowX = zoom > 1 ? "hidden" : "auto"; 

    activeImg.style.transform=`scale(${zoom}) translate(${panX/zoom}px, ${panY/zoom}px)`;
  } 
  else if(zoom > 1){
    e.preventDefault();
    panX = Math.max(Math.min(e.touches[0].clientX - panStartX, 400), -400);
    panY = Math.max(Math.min(e.touches[0].clientY - panStartY, 400), -400);
    activeImg.style.transform = `scale(${zoom}) translate(${panX/zoom}px, ${panY/zoom}px)`;
  }
},{passive:false});

slider.addEventListener("touchend", e=>{
  const now = Date.now();
  if(now - lastTap < 300 && e.target.tagName === 'IMG'){
    zoom = (zoom === 1) ? 2.5 : 1;
    if(zoom === 1) resetAll();
    else {
      slider.style.scrollSnapType = "none";
      slider.style.overflowX = "hidden";
      e.target.style.transform = `scale(2.5)`;
    }
  }
  lastTap = now;
});

slider.addEventListener("scroll", e=>{
  const idx = Math.round(e.target.scrollLeft / window.innerWidth);
  document.getElementById("galleryCounter").innerText = `${idx+1} / ${galleryImgs.length}`;
});

async function loadProperties(){
 try {
  const qs = await db.collection("properties").orderBy("timestamp","desc").get();
  const list = document.getElementById("list"); list.innerHTML = "";
  qs.forEach(doc=>{
   const d=doc.data(); const imgs=d.images||[]; const json=encodeURIComponent(JSON.stringify(imgs));
   list.innerHTML+=`
    <div class="card">
     <div class="slider">${imgs.map(i=>`<img src="${i}" onclick="openGallery('${json}')">`).join("")}</div>
     <h3 style="margin:10px 0 5px">${d.title}</h3>
     <div class="action-row">
      <a class="action call" href="tel:${d.phone}">üìû<span>Call</span></a>
      <a class="action whatsapp" href="https://wa.me/${d.phone}?text=Hi">üí¨<span>WhatsApp</span></a>
      <a class="action chat" href="chat.html?id=${doc.id}">üó®<span>Chat</span></a>
      <button class="action share" onclick="navigator.share({title:'${d.title}',url:window.location.href})">üì§<span>Share</span></button>
      <button class="action report">üö©<span>Report</span></button>
     </div>
    </div>`;
  });
 } catch(e){ console.log("error"); }
}
</script>
</body>
</html>
