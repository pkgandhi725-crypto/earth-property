<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earth Property - Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2e7d32; --bg: #f0f2f5; }
        body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        header { background: var(--primary); padding: 15px; color: white; position: sticky; top: 0; z-index: 1000; }
        .icon-btn { color: #fff; background: rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .search-box { background: white; border-radius: 12px; display: flex; padding: 2px 15px; margin-top: 10px; align-items: center; }
        .search-box input { border: none; padding: 10px; width: 100%; outline: none; }
        .prop-card { background: white; border-radius: 16px; margin: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; }
        .img-container { position: relative; aspect-ratio: 4/3; background: #eee; }
        .fav-btn { position: absolute; top: 10px; right: 10px; background: white; border: none; border-radius: 50%; width: 35px; height: 35px; color: #ccc; }
        .fav-btn.active { color: #e74c3c; }
        .share-btn { position: absolute; top: 10px; left: 10px; background: white; border: none; border-radius: 50%; width: 35px; height: 35px; color: #555; }
        .prop-info { padding: 15px; }
        .prop-price { font-size: 20px; font-weight: 800; color: var(--primary); margin: 0; }
        .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 12px; }
        .btn { padding: 10px 2px; border-radius: 8px; font-weight: 700; font-size: 11px; text-align: center; border: none; cursor: pointer; text-decoration: none; }
        .btn-call { background: #e8f5e9; color: var(--primary); }
        .btn-wa { background: #25D366; color: white; }
        .btn-chat { background: var(--primary); color: white; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #888; text-decoration: none; font-size: 10px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<header>
    <div id="welcomeText" style="font-size:11px; opacity:0.8;">Welcome, Guest</div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0; font-size: 1.2rem;">Earth Property</h2>
        <div style="display: flex; gap: 8px;">
            <div id="adminLink" class="icon-btn" style="display:none;" onclick="location.href='admin-verify.html'"><i class="fa fa-user-shield"></i></div>
            <div id="authBtn" style="cursor:pointer; font-size: 11px; font-weight: 700; background: #fff; color: var(--primary); padding: 5px 8px; border-radius: 5px;">Login</div>
        </div>
    </div>
    <div class="search-box"><i class="fa fa-search" style="color:#ccc;"></i><input type="text" id="citySearch" placeholder="Search Location..." oninput="filterData()"></div>
</header>

<div id="propertyList"></div>

<div class="bottom-nav">
    <a href="index.html" class="nav-item"><i class="fa fa-home"></i>Explore</a>
    <a href="my-ads.html" class="nav-item"><i class="fa fa-layer-group"></i>My Ads</a>
    <a href="post.html" class="nav-item"><i class="fa fa-plus-circle" style="font-size:20px; color:var(--primary);"></i>Post</a>
    <a href="favorites.html" class="nav-item"><i class="fa-regular fa-heart"></i>Favs</a>
    <a href="profile.html" class="nav-item"><i class="fa fa-user-circle"></i>Profile</a>
</div>

<div id="overlay" onclick="this.style.display='none'"><img id="overlayImg" style="max-width:90%;"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain: "earth-properties-c3c56.firebaseapp.com", projectId: "earth-properties-c3c56" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let allProps = [];

function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

async function loadProps() {
    const list = document.getElementById('propertyList');
    list.innerHTML = '<center style="padding:50px;"><i class="fa fa-spinner fa-spin fa-2x"></i></center>';
    try {
        const now = firebase.firestore.Timestamp.now();
        // Index required: expiryDate > now
        const snap = await db.collection("properties").where("expiresAt", ">", now).limit(50).get();
        allProps = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderProps(allProps);
    } catch(e) { list.innerHTML = "<center>Check Firestore Indexes.</center>"; console.log(e); }
}

function renderProps(data) {
    const list = document.getElementById('propertyList');
    list.innerHTML = data.map(p => {
        const masked = p.phone ? p.phone.slice(0,5) + "xxxxx" : "Login";
        return `
        <div class="prop-card">
            <div class="img-container">
                <button class="share-btn" onclick="shareProp('${p.title}', '${p.id}')"><i class="fa fa-share-alt"></i></button>
                <button class="fav-btn" onclick="toggleFav('${p.id}', this)"><i class="fa fa-heart"></i></button>
                <img src="${p.images?.[0] || ''}" style="width:100%;height:100%;object-fit:cover;" loading="lazy" onclick="showImg(this.src)">
            </div>
            <div class="prop-info">
                <p class="prop-price">â‚¹${Number(p.price).toLocaleString('en-IN')} <span style="font-size:10px;color:#888;">(${p.propertyType || 'Sale'})</span></p>
                <div style="font-weight:700;">${escapeHtml(p.title)}</div>
                <div style="font-size:11px;color:#777;"><i class="fa fa-map-marker-alt"></i> ${escapeHtml(p.location)}</div>
                <div class="btn-group">
                    <button class="btn btn-call" onclick="revealContact('${p.phone}', this)">Call ${masked}</button>
                    <button class="btn btn-wa" onclick="revealContact('${p.phone}', this, true)">WhatsApp</button>
                    <button onclick="openChat('${p.ownerId}', '${p.id}')" class="btn btn-chat">Chat</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function revealContact(num, btn, wa = false) {
    if (!auth.currentUser) { alert("Please login first!"); location.href='login.html'; return; }
    if (wa) window.open(`https://wa.me/91${num}`);
    else btn.innerHTML = `<a href="tel:${num}" style="text-decoration:none;color:inherit;">${num}</a>`;
}

function openChat(owner, id) { if (!auth.currentUser) location.href='login.html'; else location.href=`chat.html?to=${owner}&p=${id}`; }

function filterData() {
    const s = document.getElementById('citySearch').value.toLowerCase();
    renderProps(allProps.filter(p => (p.location||"").toLowerCase().includes(s) || (p.title||"").toLowerCase().includes(s)));
}

function shareProp(t, id) {
    const url = `${window.location.origin}/index.html?p=${id}`;
    if (navigator.share) navigator.share({title: t, url: url});
    else { navigator.clipboard.writeText(url); alert("Link Copied!"); }
}

auth.onAuthStateChanged(user => {
    if(user) {
        document.getElementById('welcomeText').innerText = "Hi, " + (user.displayName || "User");
        document.getElementById('authBtn').innerText = "Logout";
        document.getElementById('authBtn').onclick = () => auth.signOut().then(()=>location.reload());
        if(user.uid === "WOY9f67DachGVTuhR4tSJ1BHozx1") document.getElementById('adminLink').style.display='flex';
    } else { document.getElementById('authBtn').onclick = () => location.href='login.html'; }
    loadProps();
});

function showImg(src) { document.getElementById('overlayImg').src=src; document.getElementById('overlay').style.display='flex'; }
</script>
</body>
</html>
