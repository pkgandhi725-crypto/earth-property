<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Earth Property - Final</title>
<link rel="manifest" href="/earth-property/manifest.json">
<meta name="theme-color" content="#2e7d32">

<style>
/* üé® Basic Styles */
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom:20px}
header{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
#userBox{font-size:12px;opacity:.9;margin:0}
.profile-img{width:40px;height:40px;border-radius:50%;border:2px solid rgba(255,255,255,.3);object-fit:cover;cursor:pointer}
.card{background:white;margin:12px;padding:12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative}

/* üì∏ Home Slider */
.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;gap:8px}
.slider::-webkit-scrollbar{display:none}
.slider img{min-width:100%;scroll-snap-align:center;border-radius:12px;height:230px;object-fit:cover;cursor:pointer;background:#eee}

/* üñºÔ∏è Premium Fullscreen Gallery */
#gallery{position:fixed;inset:0;background:black;display:none;z-index:9999;overflow:hidden}
#gallerySlider{display:flex;height:100vh;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none}
#gallerySlider img{
  min-width:100%; height:100vh; object-fit:contain;
  touch-action: pan-x pan-y; transition: transform 0.2s ease; cursor: zoom-in;
}
#galleryCounter{position:absolute;top:25px;left:20px;color:white;background:rgba(0,0,0,.6);padding:6px 14px;border-radius:20px;font-size:14px;z-index:10001;font-weight:600}
#galleryClose{position:absolute;top:25px;right:20px;background:#2e7d32;color:white;border:none;width:44px;height:44px;border-radius:50%;font-size:28px;z-index:10001;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* ‚ö° Action Buttons (Fixed Width) */
.action-row{display:flex;justify-content:space-between;gap:4px;margin-top:12px}
.action{flex:1 1 20%;min-width:0;height:56px;border-radius:14px;background:#f5f5f5;border:none;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;text-decoration:none;color:#444;cursor:pointer}
.action span{margin-top:2px;font-weight:600;white-space:nowrap}
.fav-badge{position:absolute;top:20px;right:20px;background:white;border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.25);font-size:18px;z-index:10;cursor:pointer}
.call{background:#e3f2fd} .whatsapp{background:#e8f5e9} .chat{background:#f3e5f5} .share{background:#e0f2f1} .report{background:#ffebee}

/* üí¨ Real-time Chat Box */
#chatBox{position:fixed;bottom:0;left:0;right:0;background:white;display:none;z-index:1000;border-top:3px solid #2e7d32;border-radius:15px 15px 0 0;box-shadow:0 -5px 15px rgba(0,0,0,0.1)}
#chatHeader{background:#2e7d32;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center}
#chatMessages{max-height:300px;overflow:auto;padding:15px;background:#f9f9f9}
</style>
</head>
<body>

<header>
  <div><h3 style="margin:0">Earth Property</h3><p id="userBox">Connecting...</p></div>
  <img id="profileBtn" class="profile-img" src="https://via.placeholder.com/40/2e7d32/ffffff?text=üë§" onclick="location.href='profile.html'">
</header>

<div style="text-align:center; margin:15px">
  <a href="post.html" style="background:#2e7d32;color:white;padding:12px 24px;border-radius:25px;text-decoration:none;font-weight:600;display:inline-block">‚ûï Post Property</a>
</div>

<div id="list"></div>

<div id="gallery">
 <div id="galleryCounter">1/1</div>
 <button id="galleryClose" onclick="closeGallery()">√ó</button>
 <div id="gallerySlider"></div>
</div>

<div id="chatBox">
 <div id="chatHeader"><span id="chatTitle" style="font-weight:600">üó® Chat</span><button onclick="closeChat()" style="color:white;background:none;border:none;font-size:24px;cursor:pointer">√ó</button></div>
 <div id="chatMessages">Chat logic connecting...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
firebase.initializeApp({
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
});
const db=firebase.firestore(); const auth=firebase.auth();

// Variables
let currentUser=null, galleryImgs=[], zoom=1, lastTap=0, moveX=0, moveY=0, startX=0, startY=0, swipeY=0;

// üü¢ Auth Logic with Profile Backup
auth.onAuthStateChanged(async u=>{
 if(!u) location.href="login.html";
 else {
  currentUser=u; document.getElementById("userBox").innerText="üë§ "+u.email;
  const profileBtn = document.getElementById("profileBtn");
  try {
    const userDoc = await db.collection("users").doc(u.uid).get();
    if(userDoc.exists && userDoc.data().photoURL) profileBtn.src = userDoc.data().photoURL;
    else if(u.photoURL) profileBtn.src = u.photoURL;
  } catch(e){ console.log("Profile load failed"); }
  loadProperties();
 }
});

// üñºÔ∏è Gallery Logic
function openGallery(json){
 galleryImgs=JSON.parse(decodeURIComponent(json));
 const g=document.getElementById("gallerySlider");
 g.innerHTML="";
 galleryImgs.forEach(src=>{
  const img=document.createElement("img");
  img.src=src; g.appendChild(img);
 });
 document.getElementById("galleryCounter").innerText=`1 / ${galleryImgs.length}`;
 document.getElementById("gallery").style.display="block";
 document.body.style.overflow="hidden";
}

function closeGallery(){
 document.getElementById("gallery").style.display="none";
 document.body.style.overflow="auto";
 zoom=1; moveX=0; moveY=0;
}

// üîÑ Swipe & Zoom Handlers
document.getElementById("gallerySlider").addEventListener("scroll", e=>{
 const idx = Math.round(e.target.scrollLeft / e.target.clientWidth);
 document.getElementById("galleryCounter").innerText = `${idx+1} / ${galleryImgs.length}`;
});

document.getElementById("gallerySlider").addEventListener("touchstart", e=>{
 swipeY = e.touches[0].clientY;
 if(zoom > 1){
  startX = e.touches[0].clientX - moveX;
  startY = e.touches[0].clientY - moveY;
 }
},{passive:true});

document.getElementById("gallerySlider").addEventListener("touchmove", e=>{
 if(zoom > 1){
  moveX = (e.touches[0].clientX - startX);
  moveY = (e.touches[0].clientY - startY);
  e.target.style.transform = `scale(${zoom}) translate(${moveX/zoom}px, ${moveY/zoom}px)`;
 } else {
  if((e.touches[0].clientY - swipeY) > 120) closeGallery();
 }
},{passive:true});

document.getElementById("gallerySlider").addEventListener("touchend", e=>{
 const now = Date.now();
 if(now - lastTap < 300 && e.target.tagName=="IMG"){
  zoom = (zoom === 1) ? 2.5 : 1;
  moveX=0; moveY=0;
  e.target.style.transform = `scale(${zoom})`;
 }
 lastTap = now;
});

// üè† Load Listings
async function loadProperties(){
 const qs=await db.collection("properties").orderBy("timestamp","desc").get();
 const list=document.getElementById("list"); list.innerHTML="";
 qs.forEach(doc=>{
  const d=doc.data(); const imgs=d.images||[]; const json=encodeURIComponent(JSON.stringify(imgs));
  list.innerHTML+=`
  <div class="card">
   <div class="fav-badge" onclick="toggleFav('${doc.id}')">ü§ç</div>
   <div class="slider">${imgs.map(i=>`<img src="${i}" onclick="openGallery('${json}')">`).join("")}</div>
   <h3 style="margin:10px 0 5px">${d.title}</h3>
   <p style="margin:0; color:#666; font-size:13px">üìç ${d.location} | üí∞ ‚Çπ${d.price}</p>
   <div class="action-row">
    <a class="action call" href="tel:${d.phone}">üìû<span>Call</span></a>
    <a class="action whatsapp" href="https://wa.me/${d.phone}?text=Interested%20in%20${d.title}">üí¨<span>WhatsApp</span></a>
    <button class="action chat" onclick="openChat('${d.title}')">üó®<span>Chat</span></button>
    <button class="action share" onclick="window.navigator.share({title:'${d.title}',url:window.location.href})">üì§<span>Share</span></button>
    <button class="action report" onclick="reportPost('${doc.id}')">üö©<span>Report</span></button>
   </div>
  </div>`;
 });
}

// üõ†Ô∏è Missing Action Functions Fixed
function openChat(title){
 document.getElementById("chatTitle").innerText = "Chat: " + title;
 document.getElementById("chatBox").style.display = "block";
}
function closeChat(){ document.getElementById("chatBox").style.display = "none"; }

async function reportPost(id){
 if(confirm("Report this listing?")){
  await db.collection("properties").doc(id).update({reports: firebase.firestore.FieldValue.increment(1)});
  alert("Listing Reported.");
 }
}

function toggleFav(id){ alert("Listing saved to favorites!"); }
</script>
</body>
</html>
