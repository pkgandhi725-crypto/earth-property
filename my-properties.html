<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Properties - Earth Property</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{margin:0;font-family:system-ui,Arial;background:#f2f2f2;padding-bottom: 50px;}
header{
 background:#2e7d32; color:white; padding:14px; text-align:center;
 position:sticky; top:0; z-index: 100; display: flex; align-items: center; justify-content: center;
}
header h2 { margin: 0; font-size: 18px; }

/* Stats Bar */
.stats-bar {
    display: flex; justify-content: space-around; background: white;
    padding: 15px; margin: 10px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.stat-item { text-align: center; }
.stat-num { font-size: 20px; font-weight: 800; color: #2e7d32; }
.stat-label { font-size: 11px; color: #666; }

.list{padding:10px; max-width: 500px; margin: auto;}
.card { background:white; border-radius:14px; padding:12px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,.08); position: relative; transition: 0.3s; }
.card img { width:100%; aspect-ratio: 16/9; object-fit: cover; border-radius:10px; margin-bottom:8px; }

/* Fixed the Row Class issue */
.row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

.status-badge {
    position: absolute; top: 20px; right: 20px;
    padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
}
.active-status { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
.expired-status { background: #ffebee; color: #c62828; border: 1px solid #c62828; }

.price-tag { color: #2e7d32; font-weight: 800; font-size: 16px; }
.btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; }
button { padding: 10px 5px; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }
.edit { background: #e3f2fd; color: #1976d2; }
.del { background: #f5f5f5; color: #666; }
.share { background: #f5f5f5; color: #2e7d32; }
.renew-btn { background: #2e7d32; color: white; margin-top: 10px; width: 100%; padding: 12px; }

.home-btn { position:absolute; left:15px; background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 12px; border-radius:10px; cursor: pointer;}
</style>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
  <button class="home-btn" onclick="location.href='index.html'"><i class="fa fa-home"></i></button>
  <h2>My Properties</h2>
</header>

<div class="stats-bar" id="statsBar" style="display: none;">
    <div class="stat-item"><div class="stat-num" id="totalAds">0</div><div class="stat-label">Total</div></div>
    <div class="stat-item"><div class="stat-num" id="activeAds">0</div><div class="stat-label">Active</div></div>
    <div class="stat-item"><div class="stat-num" id="expiredAds" style="color: #d32f2f;">0</div><div class="stat-label">Expired</div></div>
</div>

<div class="list" id="list">
    <div id="loader" style="text-align:center; padding:50px; color:#999;">
        <i class="fa fa-spinner fa-spin fa-2x"></i><br><p>Fetching your listings...</p>
    </div>
</div>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

auth.onAuthStateChanged(user => {
    if(!user){ location.href="login.html"; return; }
    fetchMyProperties(user.uid);
});

function fetchMyProperties(uid) {
    db.collection("properties")
    .where("ownerId","==",uid)
    .onSnapshot(qs => {
        const list = document.getElementById("list");
        if(document.getElementById("loader")) document.getElementById("loader").remove();
        
        list.innerHTML = "";
        
        if(qs.empty){
            list.innerHTML = `<div style="text-align:center; padding:50px; color:#999;">
                <i class="fa fa-folder-open fa-3x" style="margin-bottom:10px;"></i>
                <p>You haven't posted any properties yet.</p>
                <button onclick="location.href='add-property.html'" style="background:#2e7d32; color:white; padding:12px 25px; border-radius:10px; border:none; margin:auto;">Post Property</button>
            </div>`;
            document.getElementById('statsBar').style.display = 'none';
            return;
        }

        // --- SORTING LOGIC ---
        const props = [];
        qs.forEach(doc => props.push({id: doc.id, ...doc.data()}));
        
        const now = new Date();
        props.sort((a, b) => {
            const aExp = a.expiryDate?.toDate() < now;
            const bExp = b.expiryDate?.toDate() < now;
            if (aExp !== bExp) return aExp ? 1 : -1; // Active ads on top
            return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0); // Newest first
        });

        let activeCount = 0, expiredCount = 0;

        props.forEach(p => {
            const isExpired = p.expiryDate?.toDate() < now;
            if(isExpired) expiredCount++; else activeCount++;

            const img = p.images?.[0] || "https://via.placeholder.com/400x250?text=No+Image";
            const daysLeft = Math.max(0, Math.ceil((p.expiryDate?.toDate() - now) / (1000 * 60 * 60 * 24)));

            list.innerHTML += `
                <div class="card" style="${isExpired ? 'opacity: 0.8; border: 1px solid #ffcdd2;' : ''}">
                    <span class="status-badge ${isExpired ? 'expired-status' : 'active-status'}">
                        ${isExpired ? '⚠️ Expired' : '✓ Active'}
                    </span>
                    <img src="${img}" onerror="this.src='https://via.placeholder.com/400x250?text=Image+Error'" loading="lazy">
                    <div class="row">
                        <strong style="font-size:15px; flex:1;">${escapeHtml(p.title)}</strong>
                        <span class="price-tag">₹${Number(p.price).toLocaleString('en-IN')}</span>
                    </div>
                    <p style="color:#666; font-size: 13px; margin: 4px 0;"><i class="fa fa-map-marker-alt"></i> ${escapeHtml(p.location)}</p>
                    <p style="color:#888; font-size: 11px;"><i class="fa fa-clock"></i> ${isExpired ? 'Ad ended' : daysLeft + ' days left'}</p>
                    
                    <div class="btns">
                        <button class="edit" onclick="location.href='add-property.html?edit=${p.id}'"><i class="fa fa-edit"></i> Edit</button>
                        <button class="share" onclick="shareProp('${p.id}', '${escapeHtml(p.title).replace(/'/g, "\\'")}')"><i class="fa fa-share-alt"></i> Share</button>
                        <button class="del" onclick="deleteProp('${p.id}', this)"><i class="fa fa-trash"></i> Delete</button>
                    </div>
                    
                    ${isExpired ? `<button class="renew-btn" onclick="renewProp('${p.id}', this)"><i class="fa fa-sync"></i> Renew for 30 Days</button>` : ''}
                </div>
            `;
        });

        document.getElementById('statsBar').style.display = 'flex';
        document.getElementById('totalAds').innerText = qs.size;
        document.getElementById('activeAds').innerText = activeCount;
        document.getElementById('expiredAds').innerText = expiredCount;
    });
}

function shareProp(id, title) {
    const url = `${window.location.origin}/property.html?id=${id}`;
    if(navigator.share) {
        navigator.share({ title: title, url: url }).catch(() => {});
    } else {
        navigator.clipboard.writeText(url).then(() => alert('Link copied to clipboard!'));
    }
}

async function renewProp(id, btn) {
    if(!confirm("Renew this ad for another 30 days?")) return;
    const oldHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Renewing...';
    btn.disabled = true;

    const newExpiry = new Date();
    newExpiry.setDate(newExpiry.getDate() + 30);

    try {
        await db.collection("properties").doc(id).update({
            status: "active",
            expiryDate: firebase.firestore.Timestamp.fromDate(newExpiry),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        btn.innerHTML = '<i class="fa fa-check"></i> Renewed!';
        btn.style.background = "#4caf50";
    } catch(e) {
        alert("Error: " + e.message);
        btn.innerHTML = oldHtml; btn.disabled = false;
    }
}

async function deleteProp(id, btn){
    if(!confirm("⚠️ Delete this property permanently?\nThis cannot be undone!")) return;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
    btn.disabled = true;
    try {
        await db.collection("properties").doc(id).delete();
    } catch(e) {
        alert("Error: " + e.message);
        btn.disabled = false;
    }
}
</script>

</body>
</html>
