<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Verification Requests</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2e7d32; --bg: #f4f7f6; }
        body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { font-size: 20px; color: #333; text-decoration: none; }
        
        .request-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .user-info { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .user-info b { color: var(--primary); }
        
        .docs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .doc-item { text-align: center; }
        .doc-item img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
        .doc-item p { font-size: 11px; margin-top: 5px; color: #666; font-weight: bold; }
        
        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-approve { background: var(--primary); }
        .btn-reject { background: #d32f2f; }
        
        #loader { text-align: center; padding: 50px; color: #666; }
        
        /* Full Image Overlay */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:2000; }
        #overlay img { max-width: 95%; max-height: 90%; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="back-btn"><i class="fa fa-arrow-left"></i></a>
    <h2 style="margin:0;">Pending Verifications</h2>
</header>

<div id="loader">Loading requests...</div>
<div id="requestList"></div>

<div id="overlay" onclick="this.style.display='none'"><img id="fullImg"></div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain: "earth-properties-c3c56.firebaseapp.com", projectId: "earth-properties-c3c56" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ðŸ›¡ï¸ Admin Check (Double Security)
auth.onAuthStateChanged(user => {
    if(!user || user.uid !== "WOY9f67DachGVTuhR4tSJ1BHozx1") {
        alert("Bhai, aap admin nahi ho!");
        location.href = 'index.html';
    } else {
        fetchRequests();
    }
});

async function fetchRequests() {
    const list = document.getElementById('requestList');
    const loader = document.getElementById('loader');
    
    db.collection("verification_requests").where("status", "==", "pending").onSnapshot(snap => {
        loader.style.display = 'none';
        if(snap.empty) {
            list.innerHTML = "<center style='margin-top:50px; color:#999;'>No pending requests found!</center>";
            return;
        }
        
        list.innerHTML = snap.docs.map(doc => {
            const data = doc.data();
            return `
                <div class="request-card" id="card-${doc.id}">
                    <div class="user-info">
                        <b>User:</b> ${data.email}<br>
                        <small>ID: ${data.userId}</small>
                    </div>
                    <div class="docs-grid">
                        <div class="doc-item">
                            <img src="${data.idCard}" onclick="viewImg(this.src)">
                            <p>ID CARD</p>
                        </div>
                        <div class="doc-item">
                            <img src="${data.payment}" onclick="viewImg(this.src)">
                            <p>PAYMENT</p>
                        </div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-approve" onclick="updateStatus('${data.userId}', 'approved')">Approve</button>
                        <button class="btn btn-reject" onclick="updateStatus('${data.userId}', 'rejected')">Reject</button>
                    </div>
                </div>
            `;
        }).join('');
    });
}

function viewImg(src) {
    document.getElementById('fullImg').src = src;
    document.getElementById('overlay').style.display = 'flex';
}

async function updateStatus(uid, status) {
    if(!confirm(`Bhai, kya aap sure ho isey ${status} karne ke liye?`)) return;
    
    try {
        // 1. Update verification request status
        await db.collection("verification_requests").doc(uid).update({ 
            status: status,
            reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. If approved, update user document
        if(status === 'approved') {
            await db.collection("users").doc(uid).set({
                isVerified: true,
                role: 'dealer'
            }, { merge: true });
            alert("User verified as Premium Dealer! ðŸ”¥");
        } else {
            alert("Request Rejected.");
        }
    } catch(e) {
        alert("Error: " + e.message);
    }
}
</script>
</body>
</html>
