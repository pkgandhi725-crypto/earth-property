<!DOCTYPE html>
<html>
<head>
    <title>Admin Control - Earth Property</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        header { background: #1b5e20; color: white; padding: 20px; text-align: center; border-radius: 15px; margin-bottom: 20px; }
        .stats-bar { display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; color: #2e7d32; align-items: center; }
        .search-box { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; box-sizing: border-box; }
        .card { background: white; margin-bottom: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #2e7d32; }
        .btn-group { margin-top: 12px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .del-btn { background: #ff4757; color: white; }
        .view-btn { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>

<header>
    <h2 style="margin:0;">ðŸ‘‘ Admin Control</h2>
</header>

<div class="stats-bar">
    <span>Total Ads: <span id="totalAds">0</span></span>
    <button onclick="location.href='Admin-verify.html'" class="view-btn" style="flex:none; padding: 8px 15px;">Verify Requests âž”</button>
</div>

<input type="text" id="searchBox" class="search-box" placeholder="ðŸ” Search by Title or Location...">

<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain: "earth-properties-c3c56.firebaseapp.com", projectId: "earth-properties-c3c56" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const ADMIN_UID = "WOY9f67DachGVTuhR4tSJ1BHozx1";

// XSS Protection Helper
function escape(str) { return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

onAuthStateChanged(auth, (user) => {
    if (!user || user.uid !== ADMIN_UID) window.location.href = "index.html";
    else loadProperties();
});

function loadProperties() {
    onSnapshot(query(collection(db, "properties")), (snap) => {
        const list = document.getElementById("list");
        list.innerHTML = "";
        document.getElementById("totalAds").innerText = snap.size;

        snap.forEach(docSnap => {
            const d = docSnap.data();
            const id = docSnap.id;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3>${escape(d.title)}</h3>
                <p>${escape(d.location)}</p>
                <div class="btn-group">
                    <button class="view-btn" onclick="window.open('property-details.html?id=${id}', '_blank')">View</button>
                    <button class="del-btn" id="del-${id}" onclick="deletePost('${id}')">Delete</button>
                </div>`;
            list.appendChild(card);
        });
    });
}

document.getElementById('searchBox').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(term) ? 'block' : 'none';
    });
});

window.deletePost = async (id) => {
    if (!confirm("Delete permanently?")) return;
    try { await deleteDoc(doc(db, "properties", id)); } 
    catch (e) { alert("Permission Denied!"); }
};
</script>
</body>
</html>
