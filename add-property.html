<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Property - Earth Property</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2e7d32; --bg: #f8f9fa; }
        body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); padding-bottom: 30px; }
        header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* Progress Bar Styles */
        .img-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .img-box { aspect-ratio: 1/1; border: 2px dashed #ccc; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; background: #fff; cursor: pointer; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        
        .progress-container { width: 80%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; display: none; z-index: 5; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        
        .btn-post { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 700; margin-top: 20px; cursor: pointer; }
        .btn-post:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<header>
    <div onclick="history.back()" style="cursor:pointer; padding:5px;"><i class="fa fa-arrow-left"></i></div>
    <div style="font-weight: 700;">Post New Property</div>
</header>

<div class="container">
    <div class="form-group"><label>Property Title</label><input type="text" id="title" placeholder="3bhk"></div>
    <div class="form-group" style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>Price (₹)</label><input type="number" id="price"></div>
        <div style="flex: 1;"><label>Type</label><select id="type"><option>Residential</option><option>Commercial</option></select></div>
    </div>
    <div class="form-group"><label>Location</label><input type="text" id="location"></div>
    <div class="form-group"><label>Description</label><textarea id="desc" rows="3"></textarea></div>

    <label>Photos (Max 3)</label>
    <div class="img-upload-grid">
        <div class="img-box" onclick="triggerUpload(0)">
            <i class="fa fa-camera" id="icon0"></i>
            <img id="prev0" style="display:none;">
            <div class="progress-container" id="cont0"><div class="progress-bar" id="bar0"></div></div>
        </div>
        <div class="img-box" onclick="triggerUpload(1)">
            <i class="fa fa-camera" id="icon1"></i>
            <img id="prev1" style="display:none;">
            <div class="progress-container" id="cont1"><div class="progress-bar" id="bar1"></div></div>
        </div>
        <div class="img-box" onclick="triggerUpload(2)">
            <i class="fa fa-camera" id="icon2"></i>
            <img id="prev2" style="display:none;">
            <div class="progress-container" id="cont2"><div class="progress-bar" id="bar2"></div></div>
        </div>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">

    <button class="btn-post" id="postBtn" onclick="submitProperty()" disabled>Post Property</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { 
    apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain: "earth-properties-c3c56.firebaseapp.com", 
    projectId: "earth-properties-c3c56" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cloudinary Settings
const CLOUD_NAME = "dmod7m66u";
const UPLOAD_PRESET = "earth_property";

let uploadedUrls = [null, null, null];
let uploadingCount = 0;
let activeSlot = 0;

function triggerUpload(slot) { activeSlot = slot; document.getElementById('fileInput').click(); }

function handleFile(e) {
    const file = e.target.files[0];
    if(!file) return;

    const bar = document.getElementById(`bar${activeSlot}`);
    const cont = document.getElementById(`cont${activeSlot}`);
    const icon = document.getElementById(`icon${activeSlot}`);
    const postBtn = document.getElementById('postBtn');

    // UI Reset for this slot
    cont.style.display = 'block';
    icon.style.display = 'none';
    bar.style.width = '0%';
    postBtn.disabled = true;
    postBtn.textContent = "Uploading Photo...";
    uploadingCount++;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    const xhr = new XMLHttpRequest();
    // ❌ Important: No headers added to keep it truly "Unsigned"
    xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`);

    xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            bar.style.width = percent + '%';
        }
    };

    xhr.onload = () => {
        const response = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
            uploadedUrls[activeSlot] = response.secure_url;
            document.getElementById(`prev${activeSlot}`).src = response.secure_url;
            document.getElementById(`prev${activeSlot}`).style.display = 'block';
            cont.style.display = 'none';
            uploadingCount--;
            if(uploadingCount === 0) {
                postBtn.disabled = false;
                postBtn.textContent = "Post Property";
            }
        } else {
            alert("Error: " + (response.error?.message || "Upload Failed"));
            uploadingCount--;
            icon.style.display = 'block';
        }
    };

    xhr.send(formData);
}

async function submitProperty() {
    const user = firebase.auth().currentUser;
    if(!user) return alert("Login required!");

    const title = document.getElementById('title').value;
    const finalImages = uploadedUrls.filter(u => u !== null);

    try {
        await db.collection("properties").add({
            ownerId: user.uid,
            title: title,
            price: Number(document.getElementById('price').value),
            location: document.getElementById('location').value,
            images: finalImages,
            status: "active",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Success!");
        location.href = "my-ads.html";
    } catch(e) { alert("Firestore Error: " + e.message); }
}
</script>
</body>
</html>
