<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Post Property - Earth Property</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2e7d32; --bg: #f8f9fa; --danger: #d32f2f; --accent: #e8f5e9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 30px; }
        header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        
        .form-group { margin-bottom: 18px; position: relative; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 15px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(46,125,50,0.2); }
        
        .section-title { font-size: 16px; font-weight: 700; color: var(--primary); margin: 25px 0 15px; border-bottom: 2px solid var(--accent); padding-bottom: 5px; }

        /* 5 Photo Grid */
        .img-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .img-box { aspect-ratio: 1/1; border: 2px dashed #ccc; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; background: #fff; cursor: pointer; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        
        .remove-btn { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; z-index: 10; border: none; cursor: pointer; }

        .prog-container { width: 80%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; display: none; z-index: 5; }
        .prog-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
        
        .btn-small { background: #fff; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; flex: 1; }
        .btn-small.active { background: var(--primary); color: white; }

        .btn-post { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 700; margin-top: 25px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3); }
        .btn-post:disabled { background: #999; cursor: not-allowed; }

        #rentFields { background: var(--accent); padding: 15px; border-radius: 15px; display: none; border: 1px solid #c8e6c9; margin-bottom: 18px; }

        .gps-info { 
            background: #e8f5e9; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 12px; 
            color: #2e7d32; 
            margin-top: 8px; 
            display: none; 
        }

        /* ‚úÖ Verified dealer banner */
        .verified-dealer-banner {
            display: none;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1.5px solid #1da1f2;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 20px;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #0d47a1;
        }
        .verified-dealer-banner i {
            color: #1da1f2;
            font-size: 18px;
        }
    </style>
</head>
<body>

<header>
    <div onclick="history.back()" style="cursor:pointer; padding:5px;"><i class="fa fa-arrow-left"></i></div>
    <div id="pageTitle" style="font-weight: 700; font-size: 18px;">Post Property</div>
</header>

<div class="container">

    <!-- ‚úÖ Verified Dealer Banner -->
    <div class="verified-dealer-banner" id="verifiedDealerBanner">
        <i class="fa fa-certificate"></i>
        <span>Your ad will be posted as <strong>Verified ‚úÖ</strong> automatically!</span>
    </div>

    <div class="form-group">
        <label>Property Title <span id="titleCount" style="float:right; font-size:12px; color:#999;">0/100</span></label>
        <input type="text" id="title" maxlength="100" placeholder="e.g. 3BHK Flat in City Center">
    </div>

    <div class="form-group" style="display: flex; gap: 10px;">
        <div style="flex: 1.2;"><label>Price (‚Çπ)</label><input type="number" id="price" placeholder="Amount"></div>
        <div style="flex: 1;">
            <label>Purpose</label>
            <select id="purpose" onchange="toggleRentFields()">
                <option value="Sell">Sell (180d)</option>
                <option value="Rent">Rent (30d)</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>Contact Number (WhatsApp)</label>
        <input type="text" inputmode="numeric" maxlength="10" id="phone" placeholder="10 digit mobile number">
    </div>

    <div class="form-group">
        <label>Location</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button type="button" class="btn-small active" id="btnManual" onclick="useManualMode()">‚úçÔ∏è Manual Entry</button>
            <button type="button" class="btn-small" id="btnGPS" onclick="captureGPSLocation()">üìç Use GPS</button>
        </div>
        <input type="text" id="location" placeholder="Area, City, State">
        <div id="gpsInfo" class="gps-info"></div>
    </div>

    <div class="form-group">
        <label>Property Size</label>
        <input type="text" id="size" placeholder="e.g. 1200 Sq.Ft / 100 Gaj">
    </div>

    <div id="rentFields">
        <div class="form-group">
            <label>Furnished Status</label>
            <select id="furnished">
                <option value="Unfurnished">Unfurnished</option>
                <option value="Semi-Furnished">Semi-Furnished</option>
                <option value="Fully-Furnished">Fully-Furnished</option>
            </select>
        </div>
        <div class="form-group">
            <label>Electricity & Water</label>
            <select id="bills">
                <option value="Extra">Extra (As per usage)</option>
                <option value="Included">Included in Rent</option>
            </select>
        </div>
        <div class="form-group">
            <label>Advance / Security Deposit</label>
            <input type="text" id="advance" placeholder="e.g. 2 Months Rent">
        </div>
        <div class="form-group">
            <label>Society Maintenance</label>
            <select id="maintenance">
                <option value="Included">Included in Rent</option>
                <option value="Extra Monthly">Extra Monthly Charge</option>
                <option value="Not Applicable">Not Applicable</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>Nearby Landmarks (Optional)</label>
        <input type="text" id="nearby" placeholder="e.g. Near Metro, Hospital">
    </div>

    <div class="form-group">
        <label>Description</label>
        <textarea id="desc" rows="3" placeholder="Features, facilities, etc."></textarea>
    </div>

    <label>Photos (Max 5)</label>
    <div class="img-upload-grid">
        <div class="img-box" id="box0" onclick="triggerUpload(0)"><i class="fa fa-camera" id="icon0"></i><img id="prev0" style="display:none;"><div class="prog-container" id="cont0"><div class="prog-bar" id="bar0"></div></div></div>
        <div class="img-box" id="box1" onclick="triggerUpload(1)"><i class="fa fa-camera" id="icon1"></i><img id="prev1" style="display:none;"><div class="prog-container" id="cont1"><div class="prog-bar" id="bar1"></div></div></div>
        <div class="img-box" id="box2" onclick="triggerUpload(2)"><i class="fa fa-camera" id="icon2"></i><img id="prev2" style="display:none;"><div class="prog-container" id="cont2"><div class="prog-bar" id="bar2"></div></div></div>
        <div class="img-box" id="box3" onclick="triggerUpload(3)"><i class="fa fa-camera" id="icon3"></i><img id="prev3" style="display:none;"><div class="prog-container" id="cont3"><div class="prog-bar" id="bar3"></div></div></div>
        <div class="img-box" id="box4" onclick="triggerUpload(4)"><i class="fa fa-camera" id="icon4"></i><img id="prev4" style="display:none;"><div class="prog-container" id="cont4"><div class="prog-bar" id="bar4"></div></div></div>
    </div>
    
    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
    <button class="btn-post" id="postBtn" onclick="submitProperty()">Post Property</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain: "earth-properties-c3c56.firebaseapp.com", projectId: "earth-properties-c3c56" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const CLOUD_NAME = "dnkhurnbv"; 
const UPLOAD_PRESET = "earth_property"; 

let uploadedUrls = [null, null, null, null, null];
let uploadingCount = 0;
let activeSlot = 0;
let currentCoords = { lat: null, lng: null };

// ‚úÖ Store verified user data globally
let currentUserVerified = false;
let currentUserBizName = "";

const urlParams = new URLSearchParams(window.location.search);
const editId = urlParams.get('edit');

firebase.auth().onAuthStateChanged(async user => {
    if (!user) return location.href = 'login.html';

    // ‚úÖ Check if user is a verified dealer
    try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.isVerified === true) {
                currentUserVerified = true;
                currentUserBizName = userData.businessName || "";
                // Show verified dealer banner
                document.getElementById('verifiedDealerBanner').style.display = 'flex';
            }
        }
    } catch(e) {
        console.error("User data fetch error:", e);
    }

    if (editId) loadEditData(editId, user.uid);
    
    // Title character counter
    document.getElementById('title').addEventListener('input', function() {
        document.getElementById('titleCount').innerText = this.value.length + '/100';
    });
    
    // Phone number input sanitization
    document.getElementById('phone').addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 10);
    });
});

async function loadEditData(id, uid) {
    const doc = await db.collection("properties").doc(id).get();
    if (!doc.exists || doc.data().ownerId !== uid) return history.back();
    
    const data = doc.data();
    document.getElementById('pageTitle').innerText = "Edit Property";
    document.getElementById('postBtn').innerText = "Update Property";
    
    document.getElementById('title').value = data.title || '';
    document.getElementById('titleCount').innerText = (data.title || '').length + '/100';
    document.getElementById('price').value = data.price || '';
    document.getElementById('purpose').value = data.purpose || 'Sell';
    document.getElementById('location').value = data.location || '';
    document.getElementById('desc').value = data.description || '';
    document.getElementById('phone').value = data.phone || '';
    document.getElementById('size').value = data.size || '';
    document.getElementById('nearby').value = data.nearby || '';

    toggleRentFields();
    if(data.purpose === 'Rent' && data.rentDetails) {
        document.getElementById('furnished').value = data.rentDetails.furnished;
        document.getElementById('bills').value = data.rentDetails.bills;
        document.getElementById('advance').value = data.rentDetails.advance;
        document.getElementById('maintenance').value = data.rentDetails.maintenance;
    }
    
    data.images?.forEach((url, i) => {
        if (i < 5) { uploadedUrls[i] = url; showImage(i, url); }
    });
    
    // Show GPS info if coordinates exist
    if (data.latitude && data.longitude) {
        currentCoords = { lat: data.latitude, lng: data.longitude };
        showGPSInfo();
    }
}

function toggleRentFields() {
    const rentFields = document.getElementById('rentFields');
    rentFields.style.display = document.getElementById('purpose').value === 'Rent' ? 'block' : 'none';
}

// Manual location entry
function useManualMode() {
    document.getElementById('btnManual').classList.add('active');
    document.getElementById('btnGPS').classList.remove('active');
    document.getElementById('location').placeholder = "Area, City, State";
    document.getElementById('gpsInfo').style.display = 'none';
    currentCoords = { lat: null, lng: null };
}

// GPS Capture with Manual Address Entry
function captureGPSLocation() {
    document.getElementById('btnGPS').classList.add('active');
    document.getElementById('btnManual').classList.remove('active');
    
    if (!navigator.geolocation) {
        alert('GPS not supported on your device. Please enter address manually.');
        useManualMode();
        return;
    }
    
    document.getElementById('location').placeholder = "üìç Capturing GPS location...";
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            currentCoords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            showGPSInfo();
            document.getElementById('location').placeholder = "Now type your full address here";
            document.getElementById('location').focus();
            alert('‚úì GPS Captured! Now please type your full address in the location field.');
        },
        function(error) {
            alert('GPS failed: ' + error.message + '\nPlease enter address manually.');
            useManualMode();
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function showGPSInfo() {
    const gpsInfo = document.getElementById('gpsInfo');
    gpsInfo.innerHTML = `
        <i class="fa fa-check-circle"></i> 
        GPS Captured: ${currentCoords.lat.toFixed(5)}, ${currentCoords.lng.toFixed(5)}
        <br><small>Location will be shown on map to buyers</small>
    `;
    gpsInfo.style.display = 'block';
}

function triggerUpload(slot) { 
    if (uploadedUrls[slot]) return; 
    activeSlot = slot; 
    document.getElementById('fileInput').click(); 
}

function handleFile(e) {
    const file = e.target.files[0];
    if(!file) return;
    
    // File size validation (5MB limit)
    if(file.size > 5 * 1024 * 1024) {
        alert("File too large! Maximum 5MB allowed.");
        e.target.value = '';
        return;
    }
    
    const bar = document.getElementById(`bar${activeSlot}`);
    const cont = document.getElementById(`cont${activeSlot}`);
    const icon = document.getElementById(`icon${activeSlot}`);
    
    cont.style.display = 'block'; 
    icon.style.display = 'none';
    uploadingCount++; 
    document.getElementById('postBtn').disabled = true;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`);
    xhr.upload.onprogress = (ev) => bar.style.width = (ev.loaded / ev.total * 100) + '%';
    xhr.onload = () => {
        if (xhr.status === 200) {
            const url = JSON.parse(xhr.responseText).secure_url;
            uploadedUrls[activeSlot] = url;
            showImage(activeSlot, url);
        }
        cont.style.display = 'none'; 
        uploadingCount--;
        if(uploadingCount === 0) document.getElementById('postBtn').disabled = false;
    };
    xhr.send(formData);
}

function showImage(slot, url) {
    const box = document.getElementById(`box${slot}`);
    document.getElementById(`prev${slot}`).src = url;
    document.getElementById(`prev${slot}`).style.display = 'block';
    document.getElementById(`icon${slot}`).style.display = 'none';
    if(!box.querySelector('.remove-btn')) {
        const btn = document.createElement('button');
        btn.className = 'remove-btn'; 
        btn.innerHTML = '√ó';
        btn.onclick = (e) => { e.stopPropagation(); removeImage(slot); };
        box.appendChild(btn);
    }
}

function removeImage(slot) {
    uploadedUrls[slot] = null;
    document.getElementById(`prev${slot}`).style.display = 'none';
    document.getElementById(`icon${slot}`).style.display = 'block';
    const btn = document.getElementById(`box${slot}`).querySelector('.remove-btn');
    if (btn) btn.remove();
}

async function submitProperty() {
    const user = firebase.auth().currentUser;
    const title = document.getElementById('title').value.trim();
    const price = Number(document.getElementById('price').value);
    const phone = document.getElementById('phone').value.trim();
    const location = document.getElementById('location').value.trim();
    const finalImages = uploadedUrls.filter(u => u !== null);

    // Phone validation
    if(!/^\d{10}$/.test(phone)) return alert("Enter valid 10-digit phone number");
    if(!title || price <= 0 || !location || finalImages.length === 0) {
        return alert("Please fill all required fields:\n‚Ä¢ Title\n‚Ä¢ Price\n‚Ä¢ Location\n‚Ä¢ At least 1 photo");
    }

    const purpose = document.getElementById('purpose').value;
    
    // Property data WITHOUT protected fields (ownerId, createdAt, expiryDate, isExpired)
    const propertyData = {
        title, 
        price, 
        phone, 
        purpose,
        size: document.getElementById('size').value,
        location: location,
        description: document.getElementById('desc').value.trim(),
        nearby: document.getElementById('nearby').value,
        images: finalImages,
        latitude: currentCoords.lat,
        longitude: currentCoords.lng,
        status: "active",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if(purpose === 'Rent') {
        propertyData.rentDetails = {
            furnished: document.getElementById('furnished').value,
            bills: document.getElementById('bills').value,
            advance: document.getElementById('advance').value,
            maintenance: document.getElementById('maintenance').value
        };
    }

    try {
        document.getElementById('postBtn').disabled = true;
        document.getElementById('postBtn').innerText = "Processing...";

        if (editId) {
            // EDIT MODE: Only update editable fields
            // Protected fields (ownerId, createdAt, expiryDate, isExpired) remain unchanged
            await db.collection("properties").doc(editId).update(propertyData);
            alert("Property Updated Successfully! ‚úì");
        } else {
            // NEW POST: Set all fields including protected ones
            propertyData.ownerId = user.uid;
            propertyData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            propertyData.isExpired = false;
            
            const expiry = new Date();
            expiry.setDate(expiry.getDate() + (purpose === 'Rent' ? 30 : 180));
            propertyData.expiryDate = firebase.firestore.Timestamp.fromDate(expiry);

            // ‚úÖ Auto-set isVerified if user is a verified dealer
            if (currentUserVerified) {
                propertyData.isVerified = true;
                propertyData.dealerName = currentUserBizName;
            } else {
                propertyData.isVerified = false;
            }
            
            await db.collection("properties").add(propertyData);
            alert("Property Posted Successfully! üéâ");
        }
        window.location.href = "my-ads.html";
    } catch(e) { 
        alert("Error: " + e.message); 
        document.getElementById('postBtn').disabled = false;
        document.getElementById('postBtn').innerText = editId ? "Update Property" : "Post Property";
    }
}
</script>
</body>
</html>
