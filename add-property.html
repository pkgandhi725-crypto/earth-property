<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Post Property - Earth Property</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2e7d32; --bg: #f8f9fa; }
        body { font-family: system-ui, sans-serif; margin: 0; background: var(--bg); padding-bottom: 30px; }
        header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .img-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .img-box { aspect-ratio: 1/1; border: 2px dashed #ccc; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; background: #fff; cursor: pointer; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(211, 47, 47, 0.9); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .btn-post { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 700; margin-top: 20px; cursor: pointer; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <i class="fa fa-circle-notch fa-spin fa-3x" style="color: var(--primary);"></i>
    <p id="loadingText" style="margin-top:15px; font-weight:600;">Processing...</p>
</div>

<header>
    <div onclick="history.back()" style="cursor:pointer;"><i class="fa fa-arrow-left"></i></div>
    <div style="font-weight: 700;">Post Property</div>
</header>

<div class="container">
    <div class="form-group"><label>Title</label><input type="text" id="title" placeholder="3BHK Flat..."></div>
    <div class="form-group" style="display: flex; gap: 10px;">
        <div style="flex: 1;"><label>Price (‚Çπ)</label><input type="number" id="price"></div>
        <div style="flex: 1;"><label>Type</label><select id="type"><option>Residential</option><option>Commercial</option><option>Plot</option></select></div>
    </div>
    <div class="form-group"><label>Location</label><input type="text" id="location"></div>
    <div class="form-group"><label>Description</label><textarea id="desc" rows="3"></textarea></div>

    <label>Photos (Max 3)</label>
    <div class="img-upload-grid">
        <div class="img-box" id="box0" onclick="triggerUpload(0)"><i class="fa fa-camera" id="icon0"></i><img id="prev0" style="display:none;"></div>
        <div class="img-box" id="box1" onclick="triggerUpload(1)"><i class="fa fa-camera" id="icon1"></i><img id="prev1" style="display:none;"></div>
        <div class="img-box" id="box2" onclick="triggerUpload(2)"><i class="fa fa-camera" id="icon2"></i><img id="prev2" style="display:none;"></div>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">

    <button class="btn-post" id="postBtn" onclick="submitProperty()">Post Property</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = { 
    apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain: "earth-properties-c3c56.firebaseapp.com", 
    projectId: "earth-properties-c3c56" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Cloudinary Config (Based on your screenshot)
const CLOUD_NAME = "dmod7m66u";
const UPLOAD_PRESET = "earth_property"; 

let selectedImages = [null, null, null];
let activeSlot = 0;
let userData = null;

auth.onAuthStateChanged(async (user) => {
    if (user) {
        const doc = await db.collection("users").doc(user.uid).get();
        userData = doc.exists ? doc.data() : { isVerified: false, businessName: "Dealer" };
    } else { location.href = 'login.html'; }
});

function triggerUpload(slot) { activeSlot = slot; document.getElementById('fileInput').click(); }

function handleFile(e) {
    const file = e.target.files[0];
    if(!file) return;
    selectedImages[activeSlot] = file;
    const reader = new FileReader();
    reader.onload = (event) => showPreview(activeSlot, event.target.result);
    reader.readAsDataURL(file);
}

function showPreview(slot, src) {
    document.getElementById(`prev${slot}`).src = src;
    document.getElementById(`prev${slot}`).style.display = 'block';
    document.getElementById(`icon${slot}`).style.display = 'none';
}

// ‚úÖ CLEAN CLOUDINARY UPLOAD (Fixes "Unknown API Key")
async function uploadToCloudinary(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET); // ‚úÖ Strictly using Unsigned Preset

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData // ‚ùå No headers, no API keys
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error?.message || "Upload Failed");
    return data.secure_url;
}

async function submitProperty() {
    const user = auth.currentUser;
    const title = document.getElementById('title').value;
    const price = document.getElementById('price').value;
    const location = document.getElementById('location').value;

    if(!title || !price || !location) return alert("Fill all fields!");

    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const imageUrls = [];
        for(let img of selectedImages) {
            if(img) {
                const url = await uploadToCloudinary(img);
                imageUrls.push(url);
            }
        }

        const expiry = new Date();
        expiry.setDate(expiry.getDate() + 30);

        // ‚úÖ FIXED FIRESTORE DATA (Fixes "Undefined" error)
        await db.collection("properties").add({
            ownerId: user.uid,
            title: title,
            price: Number(price),
            location: location,
            description: document.getElementById('desc').value || "",
            propertyType: document.getElementById('type').value,
            images: imageUrls,
            status: "active",
            isExpired: false,
            isVerified: userData.isVerified || false,
            businessName: userData.businessName || "Dealer",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            expiryDate: firebase.firestore.Timestamp.fromDate(expiry)
        });

        alert("Property Posted! üéâ");
        window.location.href = "my-ads.html";
    } catch (err) {
        alert("Error: " + err.message);
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}
</script>
</body>
</html>
