<!DOCTYPE html>
<html>
<head>
  <title>Admin Verification</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Pending Requests</h2>
<div id="list">Loading...</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
  authDomain: "earth-properties-c3c56.firebaseapp.com",
  projectId: "earth-properties-c3c56"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const ADMIN_UID = "WOY9f67DachGVTuhR4tSJ1BHozx1";

auth.onAuthStateChanged(user => {
  if (!user || user.uid !== ADMIN_UID) {
    alert("Admin only");
    location.href = "login.html";
  } else {
    load();
  }
});

function load() {
  db.collection("verification_requests")
    .where("status", "==", "pending")
    .onSnapshot(snap => {
      const list = document.getElementById('list');
      list.innerHTML = "";

      if (snap.empty) {
        list.innerHTML = "No pending requests";
        return;
      }

      snap.forEach(doc => {
        list.innerHTML += `
          <div>
            <b>${doc.data().businessName}</b><br>
            <button onclick="approve('${doc.id}','${doc.data().businessName}')">
              Approve
            </button>
          </div><hr>`;
      });
    });
}

async function approve(uid, bizName) {
  if (!confirm("Approve " + bizName + "?")) return;

  try {
    const batch = db.batch();

    // 1️⃣ User verified
    batch.set(db.collection("users").doc(uid), {
      isVerified: true,
      premiumDealer: true,
      role: "premium",
      verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // 2️⃣ Request approved
    batch.set(db.collection("verification_requests").doc(uid), {
      status: "approved",
      approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
      approvedBy: ADMIN_UID
    }, { merge: true });

    // 3️⃣ Properties sync (SAFE)
    const props = await db.collection("properties")
      .where("ownerId", "==", uid)
      .get();

    props.forEach(p => {
      batch.set(p.ref, { isVerified: true }, { merge: true });
    });

    await batch.commit();
    alert("✅ Approved successfully");

  } catch (e) {
    alert("❌ Error: " + e.message);
  }
}
</script>
</body>
</html>
