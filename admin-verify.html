<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Verification</title>
</head>
<body>

<h2>Pending Verification Requests</h2>
<div id="list">Loading...</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
  authDomain: "earth-properties-c3c56.firebaseapp.com",
  projectId: "earth-properties-c3c56"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const ADMIN_UID = "WOY9f67DachGVTuhR4tSJ1BHozx1";

auth.onAuthStateChanged(user => {
  if (!user || user.uid !== ADMIN_UID) {
    alert("Admin only");
    location.href = "login.html";
  } else {
    loadRequests();
  }
});

function loadRequests() {
  db.collection("verification_requests")
    .where("status", "==", "pending")
    .onSnapshot(snapshot => {
      const div = document.getElementById('list');
      div.innerHTML = '';

      if (snapshot.empty) {
        div.innerHTML = "No pending requests";
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        div.innerHTML += `
          <div style="border:1px solid #ccc; padding:10px; margin:10px">
            <b>${d.businessName}</b><br>
            UID: ${doc.id}<br><br>
            <button onclick="approve('${doc.id}','${d.businessName}')">
              APPROVE
            </button>
          </div>
        `;
      });
    });
}

async function approve(uid, name) {
  if (!confirm("Approve " + name + "?")) return;

  try {
    const batch = db.batch();

    batch.set(
      db.collection("users").doc(uid),
      {
        isVerified: true,
        premiumDealer: true,
        role: "premium"
      },
      { merge: true }
    );

    batch.set(
      db.collection("verification_requests").doc(uid),
      {
        status: "approved",
        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
      },
      { merge: true }
    );

    const props = await db.collection("properties")
      .where("ownerId", "==", uid)
      .get();

    props.forEach(p => {
      batch.set(p.ref, { isVerified: true }, { merge: true });
    });

    await batch.commit();
    alert("âœ… Approved");

  } catch (e) {
    alert(e.message);
  }
}
</script>

</body>
</html>
