<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Earth Property Verification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid #2e7d32; position: relative; }
        .doc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .doc-grid img { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-approve { background: #2e7d32; color: white; }
        .btn-reject { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status-badge { position: absolute; top: 20px; right: 20px; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #e8f5e9; color: #2e7d32; }
        .doc-label { font-size: 12px; color: #888; font-weight: 600; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color:#2e7d32;"><i class="fa fa-user-shield"></i> Pending Requests</h2>
        <button onclick="location.reload()" class="btn" style="flex:none; background:#fff; border:1px solid #ddd; padding:8px 15px;">Refresh</button>
    </div>
    <div id="requestList">Loading requests...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { 
    getFirestore, collection, doc, setDoc, addDoc, updateDoc, 
    onSnapshot, query, where, writeBatch, getDocs, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

const firebaseConfig = { 
    apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain: "earth-properties-c3c56.firebaseapp.com", 
    projectId: "earth-properties-c3c56" 
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_UID = "WOY9f67DachGVTuhR4tSJ1BHozx1";

onAuthStateChanged(auth, (user) => {
    if (!user || user.uid !== ADMIN_UID) {
        alert("Restricted Access: Admin Only!");
        window.location.href = "index.html";
    } else {
        loadRequests();
    }
});

function loadRequests() {
    const q = query(collection(db, "verification_requests"), where("status", "==", "pending"));
    
    onSnapshot(q, (snap) => {
        const list = document.getElementById('requestList');
        list.innerHTML = snap.empty ? '<div class="card">No pending requests found.</div>' : '';
        
        snap.forEach(docSnap => {
            const d = docSnap.data();
            const uid = docSnap.id;
            
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <span class="status-badge">PENDING</span>
                <h3>${d.businessName || 'Unnamed Business'}</h3>
                <p style="font-size:12px; color:#666;">User ID: ${uid}</p>
                <p style="font-size:12px; color:#999;">
                    Submitted: ${d.submittedAt ? d.submittedAt.toDate().toLocaleString('en-IN') : '‚Äî'}
                </p>
                <div class="doc-grid">
                    <div>
                        <img src="${d.idProofUrl}" onclick="window.open(this.src)" title="Click to view full image">
                        <div class="doc-label">üìÑ ID Proof</div>
                    </div>
                    <div>
                        <img src="${d.paymentUrl}" onclick="window.open(this.src)" title="Click to view full image">
                        <div class="doc-label">üí≥ Payment Screenshot</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-approve" id="app-${uid}">
                        <i class="fa fa-check"></i> APPROVE DEALER
                    </button>
                    <button class="btn btn-reject" id="rej-${uid}">
                        <i class="fa fa-times"></i> REJECT
                    </button>
                </div>
            `;

            list.appendChild(card);

            document.getElementById(`app-${uid}`).onclick = () => approveDealer(uid, d.businessName);
            document.getElementById(`rej-${uid}`).onclick = () => rejectDealer(uid, d.businessName);
        });
    }, (err) => {
        console.error("Firestore Error:", err);
        alert("Permission Denied. Check Firestore Rules!");
    });
}

async function approveDealer(uid, bizName) {
    if(!confirm(`Are you sure you want to approve "${bizName}"?`)) return;
    
    const appBtn = document.getElementById(`app-${uid}`);
    const rejBtn = document.getElementById(`rej-${uid}`);
    appBtn.disabled = true; 
    rejBtn.disabled = true;
    appBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';

    try {
        // Step 1: Update User Profile
        await setDoc(doc(db, "users", uid), { 
            isVerified: true, 
            premiumDealer: true, 
            businessName: bizName,
            verifiedAt: serverTimestamp()
        }, { merge: true });

        // Step 2: Update Request Status
        await updateDoc(doc(db, "verification_requests", uid), { 
            status: "approved", 
            approvedAt: serverTimestamp() 
        });

        // Step 3: Update Properties
        const propsSnap = await getDocs(query(collection(db, "properties"), where("ownerId", "==", uid)));
        if (!propsSnap.empty) {
            const batch = writeBatch(db);
            propsSnap.forEach(p => {
                batch.update(p.ref, { 
                    isVerified: true, 
                    dealerName: bizName 
                });
            });
            await batch.commit();
        }

        // ‚úÖ Step 4: Save Approval Notification for User
        await addDoc(collection(db, "notifications"), {
            recipientId: uid,
            type: "verification_approved",
            title: "üéâ Verification Approved!",
            message: `Congratulations! Your dealer verification for "${bizName}" has been approved. You are now a Verified Premium Dealer.`,
            read: false,
            createdAt: serverTimestamp()
        });

        alert(`‚úÖ Success! "${bizName}" is now a Verified Dealer.`);
    } catch(e) { 
        console.error("Approve Error:", e);
        alert("Error: " + e.message); 
        appBtn.disabled = false; 
        rejBtn.disabled = false;
        appBtn.innerHTML = '<i class="fa fa-check"></i> APPROVE DEALER';
    }
}

async function rejectDealer(uid, bizName) {
    const reason = prompt(`Enter Rejection Reason for "${bizName}":\n(User will see this message)`);
    if(!reason || reason.trim() === '') return;

    try {
        // Step 1: Update Request Status with Reason
        await updateDoc(doc(db, "verification_requests", uid), { 
            status: "rejected", 
            rejectionReason: reason.trim(),
            rejectedAt: serverTimestamp()
        });

        // ‚úÖ Step 2: Save Rejection Notification for User
        await addDoc(collection(db, "notifications"), {
            recipientId: uid,
            type: "verification_rejected",
            title: "‚ùå Verification Rejected",
            message: `Your verification request was rejected.\n\nReason: ${reason.trim()}\n\nPlease resubmit with correct documents.`,
            read: false,
            createdAt: serverTimestamp()
        });

        alert(`Request rejected. User has been notified.`);
    } catch(e) { 
        console.error("Reject Error:", e);
        alert(e.message); 
    }
}
</script>
</body>
</html>
