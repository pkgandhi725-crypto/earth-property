<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Admin Portal - Earth Property</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>.req-card { border:1px solid #ddd; padding:15px; margin:10px; border-radius:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }</style>
</head>
<body>
    <div style="max-width:800px; margin:auto; padding:20px;">
        <h2><i class="fa fa-shield"></i> Pending Verifications</h2>
        <div id="requestContainer">Loading requests...</div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain: "earth-properties-c3c56.firebaseapp.com", projectId: "earth-properties-c3c56" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const ADMIN_UID = "WOY9f67DachGVTuhR4tSJ1BHozx1";

        auth.onAuthStateChanged(user => {
            if(!user || user.uid !== ADMIN_UID) {
                alert("Admin Access Required!"); window.location.href = "login.html";
            } else { loadRequests(); }
        });

        function loadRequests() {
            db.collection("verification_requests").where("status", "==", "pending")
              .onSnapshot(snapshot => {
                  const container = document.getElementById('requestContainer');
                  container.innerHTML = '';
                  if(snapshot.empty) container.innerHTML = "No pending requests. ðŸ‘";
                  snapshot.forEach(doc => {
                      const data = doc.data();
                      container.innerHTML += `
                        <div class="req-card">
                            <h3>${data.businessName}</h3>
                            <button onclick="processApprove('${doc.id}', '${data.businessName}')" id="btn-${doc.id}" style="padding:10px; background:green; color:white; border:none; cursor:pointer;">Approve Dealer</button>
                        </div>`;
                  });
              }, err => { alert("Firestore Error: " + err.message); });
        }

        async function processApprove(uid, bizName) {
            if(!confirm("Verify " + bizName + "?")) return;
            const btn = document.getElementById('btn-' + uid);
            btn.disabled = true; btn.innerText = "Processing...";

            try {
                const batch = db.batch();
                // 1. User Profile: set with merge:true
                batch.set(db.collection("users").doc(uid), { isVerified: true, premiumDealer: true, role: "premium" }, { merge: true });
                // 2. Request status
                batch.update(db.collection("verification_requests").doc(uid), { status: 'approved' });
                // 3. Properties Sync
                const props = await db.collection("properties").where("ownerId", "==", uid).get();
                props.forEach(p => batch.update(p.ref, { isVerified: true }));

                await batch.commit();
                alert("âœ… Approved Successfully!");
            } catch (e) {
                alert("Error: " + e.message); btn.disabled = false; btn.innerText = "Approve Dealer";
            }
        }
    </script>
</body>
</html>
