<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Earth Property Verification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid #2e7d32; position: relative; }
        .doc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .doc-grid img { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-approve { background: #2e7d32; color: white; }
        .btn-reject { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status-badge { position: absolute; top: 20px; right: 20px; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color:#2e7d32;"><i class="fa fa-user-shield"></i> Pending Requests</h2>
        <button onclick="location.reload()" class="btn" style="flex:none; background:#fff; border:1px solid #ddd; padding:8px 15px;">Refresh</button>
    </div>
    <div id="requestList">Loading requests...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, updateDoc, onSnapshot, query, where, writeBatch, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

const firebaseConfig = { 
    apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain: "earth-properties-c3c56.firebaseapp.com", 
    projectId: "earth-properties-c3c56" 
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ✅ YOUR CONFIG
const ADMIN_UID = "WOY9f67DachGVTuhR4tSJ1BHozx1";

onAuthStateChanged(auth, (user) => {
    if (!user || user.uid !== ADMIN_UID) {
        alert("Restricted Access: Admin Only!");
        window.location.href = "index.html";
    } else {
        loadRequests();
    }
});

function loadRequests() {
    const q = query(collection(db, "verification_requests"), where("status", "==", "pending"));
    
    onSnapshot(q, (snap) => {
        const list = document.getElementById('requestList');
        list.innerHTML = snap.empty ? '<div class="card">No pending requests found.</div>' : '';
        
        snap.forEach(docSnap => {
            const d = docSnap.data();
            const uid = docSnap.id;
            
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <span class="status-badge">PENDING</span>
                <h3>${d.businessName || 'Unnamed Business'}</h3>
                <p style="font-size:12px; color:#666;">User ID: ${uid}</p>
                <div class="doc-grid">
                    <img src="${d.idProofUrl}" onclick="window.open(this.src)" title="ID Proof">
                    <img src="${d.paymentUrl}" onclick="window.open(this.src)" title="Payment Proof">
                </div>
                <div class="btn-group">
                    <button class="btn btn-approve" id="app-${uid}">APPROVE DEALER</button>
                    <button class="btn btn-reject" id="rej-${uid}">REJECT</button>
                </div>
            `;

            list.appendChild(card);

            document.getElementById(`app-${uid}`).onclick = () => approveDealer(uid, d.businessName);
            document.getElementById(`rej-${uid}`).onclick = () => rejectDealer(uid);
        });
    }, (err) => {
        console.error("Firestore Error:", err);
        alert("Permission Denied. Check Firestore Rules!");
    });
}

// ✅ IMPROVED APPROVE LOGIC (Based on your Suggestion)
async function approveDealer(uid, bizName) {
    if(!confirm(`Are you sure you want to approve ${bizName}?`)) return;
    
    const appBtn = document.getElementById(`app-${uid}`);
    const rejBtn = document.getElementById(`rej-${uid}`);
    appBtn.disabled = true; rejBtn.disabled = true;
    appBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';

    try {
        // Step 1: Update User Profile
        console.log("Step 1: Updating User...");
        await setDoc(doc(db, "users", uid), { 
            isVerified: true, 
            premiumDealer: true, 
            businessName: bizName,
            verifiedAt: serverTimestamp()
        }, { merge: true });

        // Step 2: Update Request Status
        console.log("Step 2: Updating Request Status...");
        await updateDoc(doc(db, "verification_requests", uid), { 
            status: "approved", 
            approvedAt: serverTimestamp() 
        });

        // Step 3: Update Properties (Safe Check)
        console.log("Step 3: Updating Properties...");
        const propsSnap = await getDocs(query(collection(db, "properties"), where("ownerId", "==", uid)));
        
        if (!propsSnap.empty) {
            const batch = writeBatch(db);
            propsSnap.forEach(p => {
                batch.update(p.ref, { 
                    isVerified: true, 
                    dealerName: bizName 
                });
            });
            await batch.commit();
            console.log(`Step 3: ${propsSnap.size} properties updated.`);
        } else {
            console.log("Step 3: No properties found for this user.");
        }

        alert(`Success! ${bizName} is now a Verified Dealer.`);
    } catch(e) { 
        console.error("Full Error Object:", e);
        alert("Error at step: " + e.message); 
        appBtn.disabled = false; rejBtn.disabled = false;
        appBtn.innerText = "APPROVE DEALER";
    }
}

async function rejectDealer(uid) {
    const reason = prompt("Enter Rejection Reason (User will see this):");
    if(!reason) return;

    try {
        await updateDoc(doc(db, "verification_requests", uid), { 
            status: "rejected", 
            rejectionReason: reason,
            rejectedAt: serverTimestamp()
        });
        alert("Request Rejected.");
    } catch(e) { 
        console.error("Reject Error:", e);
        alert(e.message); 
    }
}
</script>
</body>
</html>
