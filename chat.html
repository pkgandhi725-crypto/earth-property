<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earth Chat - Pro Secure</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... Purana Style Barkarar ... */
        body, html { height: 100%; margin: 0; font-family: system-ui; background: #e5ddd5; display: flex; flex-direction: column; overflow: hidden; }
        header { background: #2e7d32; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 50px;}
        #chatPartner { font-weight: 700; font-size: 16px; }
        #propStatus { font-size: 11px; opacity: 0.9; }
        .dropdown { position: absolute; right: 10px; top: 45px; background: white; color: #333; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; min-width: 160px; z-index: 200; }
        .dropdown div { padding: 12px 15px; font-size: 14px; cursor: pointer; border-bottom: 1px solid #eee; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .sent { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 2px; }
        .received { align-self: flex-start; background: white; border-top-left-radius: 2px; }
        .msg-img { width: 100%; max-width: 250px; border-radius: 8px; cursor: pointer; display: block; margin-top: 5px; }
        .time { font-size: 10px; color: #888; margin-top: 4px; text-align: right; display: block; }
        .chat-input-container { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; align-items: center; }
        .input-wrapper { flex: 1; background: white; border-radius: 25px; display: flex; align-items: center; padding: 2px 15px; }
        #msgInput { flex: 1; border: none; padding: 10px 5px; outline: none; font-size: 15px; background: transparent; }
        .send-btn { background: #2e7d32; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        #blockBanner { background: #ffebee; color: #c62828; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; display: none; }
        #reportModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <a href="inbox.html" style="color:white;"><i class="fa fa-arrow-left"></i></a>
        <div>
            <div id="chatPartner">Loading...</div>
            <div id="propStatus">Connecting...</div>
        </div>
    </div>
    <div onclick="toggleMenu(event)" style="padding:5px; cursor:pointer;"><i class="fa fa-ellipsis-v"></i></div>
    <div class="dropdown" id="myDropdown">
        <div id="blockAction" onclick="toggleBlock()">Block User</div>
        <div onclick="openReportModal()" style="color:#d32f2f;">Report User</div>
    </div>
</header>

<div id="blockBanner"></div>
<div id="messages"></div>
<div id="imgLoading" style="display:none; text-align:center; padding:5px; font-size:12px; background:#ddd;"><i class="fa fa-spinner fa-spin"></i> Sending...</div>

<div class="chat-input-container" id="inputArea">
    <div class="input-wrapper">
        <button class="chat-btn" style="border:none; background:none; color:#555;" onclick="document.getElementById('chatFileInput').click()"><i class="fa fa-camera"></i></button>
        <input type="file" id="chatFileInput" hidden accept="image/*" onchange="handleImageUpload(event)">
        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
    </div>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
</div>

<div id="reportModal">
    <div class="modal-content">
        <h3>Report User</h3>
        <button onclick="submitReport('Spam')">Spam</button>
        <button onclick="submitReport('Abuse')">Abuse</button>
        <button onclick="closeReportModal()">Cancel</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = { apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", authDomain: "earth-properties-c3c56.firebaseapp.com", projectId: "earth-properties-c3c56" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const params = new URLSearchParams(window.location.search);
const partnerId = params.get('to');
const propId = params.get('p');
let currentRoomId = null, isPartnerBlocked = false, amIBlocked = false;

// üõ°Ô∏è XSS & Image Validation
function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
function isValidImg(url) { try { const p = new URL(url); return p.protocol === 'https:' && p.hostname.includes('cloudinary.com'); } catch { return false; } }

// ‚å®Ô∏è Enter to Send
document.getElementById('msgInput').addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });

auth.onAuthStateChanged(async user => {
    if(!user) return location.href='login.html';
    const ids = [user.uid, partnerId].sort();
    currentRoomId = `${ids[0]}_${ids[1]}_${propId}`;
    
    await checkBlockStatus(user.uid);
    loadMessages();
    setupTypingIndicator(user.uid);
});

async function checkBlockStatus(myUid) {
    return new Promise(res => {
        db.collection("users").doc(myUid).onSnapshot(d => {
            isPartnerBlocked = (d.data()?.blockedUsers || []).includes(partnerId);
            updateUI(); res();
        });
        db.collection("users").doc(partnerId).onSnapshot(d => {
            amIBlocked = (d.data()?.blockedUsers || []).includes(myUid);
            updateUI(); res();
        });
    });
}

function updateUI() {
    const blocked = isPartnerBlocked || amIBlocked;
    document.getElementById('msgInput').disabled = blocked;
    document.getElementById('sendBtn').disabled = blocked;
    document.getElementById('blockBanner').style.display = blocked ? 'block' : 'none';
    document.getElementById('blockBanner').innerText = isPartnerBlocked ? "You blocked this user" : "User unavailable";
}

// üì∏ Image Compression
async function handleImageUpload(e) {
    const file = e.target.files[0];
    if(!file || isPartnerBlocked || amIBlocked) return;
    
    document.getElementById('imgLoading').style.display = 'block';
    const reader = new FileReader();
    reader.onload = async (event) => {
        const img = new Image();
        img.onload = async () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_W = 800;
            canvas.width = MAX_W;
            canvas.height = img.height * (MAX_W / img.width);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', 'Earth_Property');
                const res = await fetch("https://api.cloudinary.com/v1_1/dmod7m66u/image/upload", { method:'POST', body:formData });
                const data = await res.json();
                saveMsg(data.secure_url, 'image');
                document.getElementById('imgLoading').style.display = 'none';
                e.target.value = '';
            }, 'image/jpeg', 0.7);
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
}

function loadMessages() {
    db.collection("chats").doc(currentRoomId).collection("messages").orderBy("timestamp","asc").onSnapshot(snap => {
        const msgDiv = document.getElementById('messages');
        msgDiv.innerHTML = '';
        snap.forEach(doc => {
            const d = doc.data();
            if(isPartnerBlocked && d.senderId === partnerId) return; // Don't show new messages if blocked
            const isMe = d.senderId === auth.currentUser.uid;
            const content = d.type === 'image' ? (isValidImg(d.text) ? `<img src="${d.text}" class="msg-img" onclick="window.open('${d.text}')">` : '‚ö†Ô∏è Blocked Image') : escapeHtml(d.text);
            msgDiv.innerHTML += `<div class="msg ${isMe ? 'sent' : 'received'}">${content}</div>`;
        });
        msgDiv.scrollTop = msgDiv.scrollHeight;
    });
}

async function sendMessage() {
    const msgInput = document.getElementById('msgInput');
    const text = msgInput.value.trim();
    if(!text || isPartnerBlocked || amIBlocked) return;
    msgInput.value = '';
    saveMsg(text, 'text');
}

async function saveMsg(content, type) {
    const myUid = auth.currentUser.uid;
    const batch = db.batch();
    const msgRef = db.collection("chats").doc(currentRoomId).collection("messages").doc();
    batch.set(msgRef, { senderId: myUid, text: content, type: type, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    batch.set(db.collection("chats").doc(currentRoomId), { lastMessage: content, users: [myUid, partnerId], lastUpdate: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    await batch.commit();
}

function setupTypingIndicator(myUid) {
    const input = document.getElementById('msgInput');
    input.addEventListener('input', () => {
        db.collection("chats").doc(currentRoomId).set({ [`typing_${myUid}`]: true }, { merge: true });
        clearTimeout(window.typingT);
        window.typingT = setTimeout(() => {
            db.collection("chats").doc(currentRoomId).set({ [`typing_${myUid}`]: false }, { merge: true });
        }, 2000);
    });
    db.collection("chats").doc(currentRoomId).onSnapshot(d => {
        if(d.data()?.[`typing_${partnerId}`]) document.getElementById('propStatus').innerText = "typing...";
        else document.getElementById('propStatus').innerText = "Online";
    });
}

function toggleMenu(e) { e.stopPropagation(); const d = document.getElementById('myDropdown'); d.style.display = d.style.display==='block'?'none':'block'; }
window.onclick = () => document.getElementById('myDropdown').style.display='none';
</script>
</body>
</html>
