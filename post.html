<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Post Property - Earth Property</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;padding:12px;font-family:system-ui,Arial;background:#f2f2f2;}
header{background:#2e7d32;color:white;padding:16px;border-radius:12px;text-align:center;margin-bottom:10px;}

input,textarea,select{
 width:100%;padding:12px;margin:8px 0;border-radius:10px;
 border:1px solid #ddd;font-size:15px;box-sizing:border-box;
}

button{
 background:#2e7d32;color:white;border:none;
 padding:14px;width:100%;border-radius:20px;
 font-size:16px;font-weight:600;cursor:pointer;
}
button:disabled{opacity:0.6}

.upload-box{
 border:2px dashed #2e7d32;
 padding:16px;border-radius:12px;text-align:center;
 background:#e8f5e8;cursor:pointer;margin:10px 0;
 font-weight:600;color:#2e7d32;
}
.upload-box:hover{background:#d4edda;}

.preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.preview img{width:70px;height:70px;border-radius:8px;object-fit:cover;border:2px solid #ddd;}

#progress{height:10px;background:#ddd;border-radius:10px;margin-top:10px;overflow:hidden;display:none;}
#bar{height:100%;width:0%;background:#2e7d32;transition:width 0.3s;}

#loading{display:none;margin-top:10px;color:#2e7d32;font-weight:600;}
#error{display:none;margin-top:10px;color:#d32f2f;font-weight:600;padding:10px;background:#ffebee;border-radius:8px;}
</style>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
<h2>‚ûï Post Property</h2>
</header>

<form id="form">

<input id="title" placeholder="Property title *" required>
<input id="locationInput" placeholder="Location *" required>

<select id="type">
 <option value="sale">For Sale</option>
 <option value="rent">For Rent</option>
</select>

<input id="price" type="number" step="any" placeholder="Price" required>
<input id="phone" placeholder="Phone / WhatsApp *" required>
<textarea id="desc" placeholder="Full description..." rows="4"></textarea>

<div class="upload-box" onclick="document.getElementById('photos').click()">
 üì∑ Upload Photos (Max 5 images)
</div>
<input type="file" id="photos" multiple accept="image/*" hidden>

<div class="preview" id="preview"></div>

<div id="progress"><div id="bar"></div></div>
<div id="loading">‚è≥ Uploading images...</div>
<div id="error"></div>

<button id="submitBtn" type="submit">üöÄ Post Property</button>

</form>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50",
 authDomain:"earth-properties-c3c56.firebaseapp.com",
 projectId:"earth-properties-c3c56"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const cloudName = "dnkhurnbv";
const uploadPreset = "earth_property";

const title = document.getElementById("title");
const locationInput = document.getElementById("locationInput");
const type = document.getElementById("type");
const price = document.getElementById("price");
const phone = document.getElementById("phone");
const desc = document.getElementById("desc");
const photos = document.getElementById("photos");
const preview = document.getElementById("preview");
const bar = document.getElementById("bar");
const progress = document.getElementById("progress");
const loading = document.getElementById("loading");
const errorDiv = document.getElementById("error");
const submitBtn = document.getElementById("submitBtn");

function showError(msg){
 errorDiv.textContent = msg;
 errorDiv.style.display = "block";
 loading.style.display = "none";
 progress.style.display = "none";
 submitBtn.disabled = false;
}

photos.onchange = ()=>{
 preview.innerHTML="";
 if(photos.files.length > 5){
  alert("Max 5 photos only");
  photos.value="";
  return;
 }
 [...photos.files].forEach(f=>{
  const url = URL.createObjectURL(f);
  const img = document.createElement("img");
  img.src = url;
  img.onload = ()=>URL.revokeObjectURL(url);
  preview.appendChild(img);
 });
};

document.getElementById("form").onsubmit = async e=>{
 e.preventDefault();
 errorDiv.style.display="none";

 const user = auth.currentUser;
 if(!user){
  alert("Login first");
  window.location.href="login.html";
  return;
 }

 if(photos.files.length===0){
  showError("Add at least 1 photo");
  return;
 }

 submitBtn.disabled=true;
 loading.style.display="block";
 progress.style.display="block";
 bar.style.width="0%";

 try{
  const files=[...photos.files];
  const urls=[];

  for(let i=0;i<files.length;i++){
   const fd=new FormData();
   fd.append("file",files[i]);
   fd.append("upload_preset",uploadPreset);

   const r=await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,{
    method:"POST", body:fd
   });

   if(!r.ok) throw new Error("Upload failed");
   const d=await r.json();
   urls.push(d.secure_url);

   bar.style.width=((i+1)/files.length*80)+"%";
  }

  await db.collection("properties").add({
   title:title.value.trim(),
   location:locationInput.value.trim(),
   type:type.value,
   price:Number(price.value),
   phone:phone.value.trim(),
   description:desc.value,
   images:urls,
   ownerId:user.uid,
   ownerEmail:user.email,
   timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });

  bar.style.width="100%";
  alert("Property Posted!");
  window.location.href="my-properties.html";

 }catch(err){
  showError("Upload failed: "+err.message);
 }
};
</script>

</body>
</html>
