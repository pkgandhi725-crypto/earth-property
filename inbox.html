<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Earth Property</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; font-family: system-ui; background: #f0f2f5; }
        header { 
            background: linear-gradient(135deg, #2e7d32, #1b5e20); 
            color: white; 
            padding: 15px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .header-title { 
            flex: 1; 
            font-size: 18px; 
        }
        
        .chat-list { 
            padding: 12px; 
        }
        
        .chat-card { 
            background: white; 
            border-radius: 12px; 
            padding: 12px; 
            display: flex; 
            gap: 12px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border-left: 4px solid transparent; 
            transition: 0.2s; 
            position: relative; 
        }
        .chat-card:active { 
            transform: scale(0.98); 
        }
        .chat-card.unread { 
            border-left-color: #2e7d32; 
            background: linear-gradient(90deg, #fafffa 0%, white 100%); 
        }
        
        .property-thumb { 
            width: 70px; 
            height: 70px; 
            border-radius: 10px; 
            object-fit: cover; 
            background: #f0f0f0; 
            flex-shrink: 0; 
        }
        
        .chat-info { 
            flex: 1; 
            min-width: 0; 
        }
        .chat-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px; 
        }
        .chat-name { 
            font-weight: 700; 
            font-size: 15px; 
            color: #333; 
        }
        .chat-time { 
            font-size: 11px; 
            color: #999; 
            white-space: nowrap; 
        }
        
        .property-title { 
            font-size: 12px; 
            color: #2e7d32; 
            font-weight: 600; 
            margin-bottom: 4px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .property-title i { 
            font-size: 10px; 
            margin-right: 4px; 
        }
        
        .chat-last { 
            font-size: 13px; 
            color: #666; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .chat-last.unread { 
            font-weight: 600; 
            color: #333; 
        }
        
        .badge { 
            background: #2e7d32; 
            color: white; 
            font-size: 10px; 
            padding: 3px 8px; 
            border-radius: 10px; 
            font-weight: 800; 
            margin-left: 8px; 
        }
        
        .delete-btn { 
            position: absolute; 
            top: 12px; 
            right: 12px; 
            background: #ffebee; 
            color: #d32f2f; 
            border: none; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            transition: 0.2s; 
        }
        .chat-card:hover .delete-btn { 
            display: flex; 
        }
        .delete-btn:hover { 
            background: #d32f2f; 
            color: white; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 80px 20px; 
            color: #999; 
        }
        .empty-state i { 
            font-size: 60px; 
            margin-bottom: 20px; 
            opacity: 0.3; 
        }
        .empty-state h3 { 
            color: #666; 
            margin: 10px 0; 
        }
        .empty-state p { 
            font-size: 14px; 
        }
        
        .loading { 
            text-align: center; 
            padding: 50px; 
            color: #2e7d32; 
        }
        .loading i { 
            font-size: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .tab-bar { 
            background: white; 
            display: flex; 
            padding: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            position: sticky; 
            top: 55px; 
            z-index: 99; 
        }
        .tab { 
            flex: 1; 
            padding: 15px; 
            text-align: center; 
            font-weight: 600; 
            font-size: 14px; 
            color: #666; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: 0.2s; 
        }
        .tab.active { 
            color: #2e7d32; 
            border-bottom-color: #2e7d32; 
        }
    </style>
</head>
<body>

<header>
    <i class="fa fa-arrow-left" style="cursor: pointer;" onclick="location.href='index.html'"></i>
    <span class="header-title">Messages</span>
    <i class="fa fa-ellipsis-v" style="cursor: pointer; opacity: 0.7;"></i>
</header>

<div class="tab-bar">
    <div class="tab active" onclick="switchTab('all')">
        All <span id="allCount" style="opacity: 0.7;"></span>
    </div>
    <div class="tab" onclick="switchTab('unread')">
        Unread <span id="unreadBadge" class="badge" style="display: none;">0</span>
    </div>
</div>

<div class="chat-list" id="chatList">
    <div class="loading">
        <i class="fa fa-spinner fa-spin"></i>
        <p>Loading conversations...</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = { 
    apiKey: "AIzaSyDJ_qGtz1lx_orG4brwp4xUHWdrKctgJ50", 
    authDomain: "earth-properties-c3c56.firebaseapp.com", 
    projectId: "earth-properties-c3c56" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let allChats = [];
let currentTab = 'all';

auth.onAuthStateChanged(user => {
    if (!user) { 
        location.href = 'login.html'; 
        return; 
    }
    listenForChats(user.uid);
});

function listenForChats(uid) {
    db.collection("chats")
        .where("users", "array-contains", uid)
        .orderBy("lastUpdate", "desc")
        .onSnapshot(async snap => {
            const list = document.getElementById("chatList");
            
            if (snap.empty) { 
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-comments"></i>
                        <h3>No Messages Yet</h3>
                        <p>Start chatting with property owners!</p>
                    </div>`;
                return; 
            }

            allChats = [];
            let unreadCount = 0;

            for (const doc of snap.docs) {
                const d = doc.data();
                const chatId = doc.id;
                const otherId = d.users.find(id => id !== uid);
                const isUnread = d.lastSenderId !== uid && !d.isSeen;
                
                if (isUnread) unreadCount++;

                // Fetch other user info
                let userName = "User";
                let userEmail = "";
                try {
                    const userDoc = await db.collection("users").doc(otherId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        userName = userData.displayName || userData.name || userData.email?.split('@')[0] || "User";
                        userEmail = userData.email || "";
                    }
                } catch (e) {
                    console.error("Error fetching user:", e);
                }

                // Fetch property info
                let propertyTitle = "Property";
                let propertyImage = "https://via.placeholder.com/70?text=No+Image";
                if (d.propId) {
                    try {
                        const propDoc = await db.collection("properties").doc(d.propId).get();
                        if (propDoc.exists) {
                            const propData = propDoc.data();
                            propertyTitle = propData.title || "Property";
                            if (propData.images && propData.images.length > 0) {
                                propertyImage = propData.images[0];
                            }
                        }
                    } catch (e) {
                        console.error("Error fetching property:", e);
                    }
                }

                // Format time
                let timeAgo = "Just now";
                if (d.lastUpdate) {
                    const now = new Date();
                    const lastUpdate = d.lastUpdate.toDate();
                    const diff = now - lastUpdate;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    
                    if (minutes < 1) timeAgo = "Just now";
                    else if (minutes < 60) timeAgo = `${minutes}m ago`;
                    else if (hours < 24) timeAgo = `${hours}h ago`;
                    else if (days < 7) timeAgo = `${days}d ago`;
                    else timeAgo = lastUpdate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                }

                allChats.push({
                    chatId,
                    otherId,
                    userName,
                    userEmail,
                    propertyTitle,
                    propertyImage,
                    lastMessage: d.lastMessage || "No messages yet",
                    timeAgo,
                    isUnread,
                    propId: d.propId
                });
            }

            // Update badge
            if (unreadCount > 0) {
                document.getElementById('unreadBadge').style.display = 'inline';
                document.getElementById('unreadBadge').innerText = unreadCount;
            } else {
                document.getElementById('unreadBadge').style.display = 'none';
            }
            document.getElementById('allCount').innerText = `(${allChats.length})`;

            renderChats();
        });
}

function renderChats() {
    const list = document.getElementById("chatList");
    
    let filtered = allChats;
    if (currentTab === 'unread') {
        filtered = allChats.filter(c => c.isUnread);
    }

    if (filtered.length === 0) {
        if (currentTab === 'unread') {
            list.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-check-double"></i>
                    <h3>All Caught Up!</h3>
                    <p>No unread messages.</p>
                </div>`;
        } else {
            list.innerHTML = `
                <div class="empty-state">
                    <i class="fa fa-comments"></i>
                    <h3>No Messages Yet</h3>
                    <p>Start chatting with property owners!</p>
                </div>`;
        }
        return;
    }

    list.innerHTML = filtered.map(chat => `
        <div class="chat-card ${chat.isUnread ? 'unread' : ''}" 
             onclick="openChat('${chat.otherId}', '${chat.propId || ''}')">
            <img src="${chat.propertyImage}" 
                 class="property-thumb" 
                 alt="Property"
                 onerror="this.src='https://via.placeholder.com/70?text=Property'">
            
            <div class="chat-info">
                <div class="chat-header">
                    <div>
                        <span class="chat-name">${escapeHtml(chat.userName)}</span>
                        ${chat.isUnread ? '<span class="badge">NEW</span>' : ''}
                    </div>
                    <span class="chat-time">${chat.timeAgo}</span>
                </div>
                
                <div class="property-title">
                    <i class="fa fa-home"></i>
                    ${escapeHtml(chat.propertyTitle)}
                </div>
                
                <div class="chat-last ${chat.isUnread ? 'unread' : ''}">
                    ${escapeHtml(chat.lastMessage)}
                </div>
            </div>
            
            <button class="delete-btn" onclick="deleteChat(event, '${chat.chatId}', '${escapeHtml(chat.userName)}')">
                <i class="fa fa-trash-alt"></i>
            </button>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    renderChats();
}

function openChat(otherId, propId) {
    const url = propId ? `chat.html?to=${otherId}&p=${propId}` : `chat.html?to=${otherId}`;
    location.href = url;
}

// ✅ FIXED: Delete messages subcollection FIRST, then parent document
async function deleteChat(event, chatId, userName) {
    event.stopPropagation();
    
    if (!confirm(`Delete conversation with ${userName}?\n\nThis will remove the entire chat history.`)) {
        return;
    }
    
    try {
        // ✅ Step 1: Delete all messages in subcollection FIRST
        const messagesSnap = await db.collection("chats").doc(chatId).collection("messages").get();
        if (!messagesSnap.empty) {
            const deletePromises = messagesSnap.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
        }

        // ✅ Step 2: Delete parent chat document AFTER messages are deleted
        await db.collection("chats").doc(chatId).delete();

    } catch (e) {
        alert("Error deleting conversation: " + e.message);
    }
}
</script>
</body>
</html>
